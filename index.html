<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rugby Strength Tracker v5.1 - Strength Score</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Work+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --niue-yellow: #FFCD00;
            --niue-blue: #012169;
            --light-blue: #4A6FA5;
            --pale-yellow: #FFF9E6;
            --cream: #FFFBF0;
            --shadow: rgba(1, 33, 105, 0.12);
            --green: #22c55e;
            --red: #ef4444;
            --orange: #f97316;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Work Sans', sans-serif;
            background: linear-gradient(135deg, var(--pale-yellow) 0%, var(--cream) 100%);
            min-height: 100vh;
            padding: 0;
        }

        .header {
            background: var(--niue-blue);
            padding: 24px 20px 16px;
            box-shadow: 0 4px 20px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .flag-accent {
            width: 60px;
            height: 8px;
            background: linear-gradient(90deg, var(--niue-yellow) 0%, var(--niue-yellow) 50%, var(--niue-blue) 50%, var(--niue-blue) 100%);
            margin-bottom: 16px;
            border-radius: 4px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .app-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            color: white;
            letter-spacing: 1px;
        }

        .session-timer {
            background: rgba(255, 205, 0, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            color: var(--niue-yellow);
            letter-spacing: 0.5px;
        }

        .session-timer.active {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .tab-navigation {
            display: flex;
            gap: 8px;
        }

        .tab-btn {
            font-family: 'Bebas Neue', sans-serif;
            padding: 8px 16px;
            border: 2px solid var(--niue-yellow);
            background: transparent;
            color: var(--niue-yellow);
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
            flex: 1;
        }

        .tab-btn.active {
            background: var(--niue-yellow);
            color: var(--niue-blue);
        }

        .session-control {
            margin: 20px;
            text-align: center;
        }

        .start-workout-btn {
            font-family: 'Bebas Neue', sans-serif;
            padding: 20px 40px;
            background: var(--green);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 1px;
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.3);
            width: 100%;
        }

        .start-workout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(34, 197, 94, 0.4);
        }

        .start-workout-btn.active {
            background: var(--red);
        }

        .workout-progress {
            margin: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 12px var(--shadow);
        }

        .progress-bar-container {
            background: #e0e0e0;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--niue-yellow) 0%, var(--niue-blue) 100%);
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            color: var(--light-blue);
            font-weight: 600;
            font-size: 14px;
        }

        .day-info {
            background: white;
            margin: 20px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 12px var(--shadow);
            border-left: 5px solid var(--niue-yellow);
        }

        .day-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 24px;
            color: var(--niue-blue);
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .day-description {
            color: var(--light-blue);
            font-size: 14px;
            font-weight: 500;
        }

        .exercises-list {
            padding: 0 20px 100px;
        }

        .exercise-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .exercise-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow);
            border-color: var(--niue-yellow);
        }

        .exercise-card.logged::before {
            content: '‚úì';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            background: var(--green);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
        }

        .exercise-card.in-progress {
            border-color: var(--niue-yellow);
            background: var(--pale-yellow);
        }

        .pr-badge {
            position: absolute;
            top: 10px;
            right: 50px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: var(--niue-blue);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
            letter-spacing: 0.5px;
        }

        .exercise-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .exercise-number {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 22px;
            color: var(--niue-blue);
            min-width: 28px;
            font-weight: 400;
        }

        .exercise-info {
            flex: 1;
        }

        .exercise-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--niue-blue);
            margin-bottom: 4px;
        }

        .exercise-details {
            font-size: 14px;
            color: var(--light-blue);
            font-weight: 500;
        }

        .exercise-stats {
            margin-top: 8px;
            display: flex;
            gap: 16px;
            font-size: 12px;
        }

        .stat-item {
            color: #888;
        }

        .stat-item strong {
            color: var(--niue-blue);
            font-weight: 600;
        }

        .stat-trend {
            display: inline-block;
            margin-left: 4px;
        }

        .stat-trend.up {
            color: var(--green);
        }

        .stat-trend.down {
            color: var(--red);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(1, 33, 105, 0.8);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            border-radius: 16px;
            overflow-y: auto;
            animation: slideUp 0.4s ease;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: var(--niue-blue);
            padding: 24px 20px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 24px;
            color: white;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }

        .modal-subtitle {
            color: var(--niue-yellow);
            font-size: 14px;
            font-weight: 500;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 205, 0, 0.2);
            border: none;
            color: var(--niue-yellow);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 20;
        }

        .close-btn:hover {
            background: var(--niue-yellow);
            color: var(--niue-blue);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 24px 20px;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--niue-blue);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 2000;
            transition: transform 0.3s ease;
            max-width: 90%;
            text-align: center;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            background: var(--green);
        }

        .toast.error {
            background: var(--red);
        }

        .toast.info {
            background: var(--light-blue);
        }

        /* Undo Button */
        .undo-container {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2001;
        }

        .undo-btn {
            background: var(--niue-yellow);
            color: var(--niue-blue);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
        }

        .undo-btn:hover {
            transform: translateY(-2px);
        }

        .view-only-notice {
            background: #e8f4f8;
            border: 2px solid var(--light-blue);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            text-align: center;
        }

        .view-only-notice strong {
            color: var(--niue-blue);
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .view-only-notice p {
            color: var(--light-blue);
            font-size: 14px;
        }

        .rest-timer-section {
            background: var(--pale-yellow);
            border: 3px solid var(--niue-yellow);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }

        .rest-timer-section.active {
            background: var(--niue-blue);
            border-color: var(--niue-blue);
        }

        .rest-timer-display {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 48px;
            color: var(--niue-blue);
            margin-bottom: 16px;
            letter-spacing: 2px;
        }

        .rest-timer-section.active .rest-timer-display {
            color: var(--niue-yellow);
        }

        .rest-timer-controls {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .timer-btn {
            padding: 10px 20px;
            border: 2px solid var(--niue-blue);
            background: white;
            color: var(--niue-blue);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .timer-btn:hover {
            background: var(--niue-blue);
            color: white;
        }

        .timer-btn.active {
            background: var(--red);
            border-color: var(--red);
            color: white;
        }

        .prefill-section {
            background: #e8f4f8;
            border: 2px solid var(--light-blue);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .prefill-title {
            font-weight: 600;
            color: var(--niue-blue);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .prefill-data {
            color: var(--light-blue);
            font-size: 13px;
            margin-bottom: 12px;
        }

        .prefill-btn {
            width: 100%;
            padding: 10px;
            background: var(--light-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .prefill-btn:hover {
            background: var(--niue-blue);
        }

        .section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 16px;
            color: var(--niue-blue);
            margin-bottom: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .sets-container {
            margin-bottom: 24px;
        }

        .set-row {
            display: grid;
            grid-template-columns: 50px 1fr 1fr 40px;
            gap: 12px;
            margin-bottom: 12px;
            align-items: center;
        }

        .set-label {
            font-weight: 600;
            color: var(--niue-blue);
            font-size: 14px;
        }

        .input-group {
            position: relative;
        }

        .input-field {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            color: var(--niue-blue);
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--niue-yellow);
            background: var(--pale-yellow);
        }

        .input-field:disabled {
            background: #f5f5f5;
            color: #999;
        }

        .input-label {
            position: absolute;
            top: -8px;
            left: 8px;
            background: white;
            padding: 0 4px;
            font-size: 11px;
            color: #888;
            font-weight: 500;
        }

        .remove-set {
            background: #fee;
            border: none;
            color: #c44;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .remove-set:hover {
            background: #c44;
            color: white;
        }

        .add-set-btn {
            width: 100%;
            padding: 12px;
            background: var(--pale-yellow);
            border: 2px dashed var(--niue-yellow);
            color: var(--niue-blue);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 24px;
        }

        .add-set-btn:hover {
            background: var(--niue-yellow);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--pale-yellow);
            padding: 16px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid var(--niue-yellow);
        }

        .stat-card.pr {
            background: linear-gradient(135deg, #fff9e6 0%, #fffbf0 100%);
            border-color: #ffd700;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2);
        }

        .stat-label {
            font-size: 12px;
            color: var(--light-blue);
            font-weight: 600;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            color: var(--niue-blue);
            letter-spacing: 0.5px;
        }

        .stat-comparison {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }

        .stat-comparison.up {
            color: var(--green);
        }

        .notes-section {
            margin-bottom: 24px;
        }

        .notes-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Work Sans', sans-serif;
            resize: vertical;
            min-height: 60px;
        }

        .notes-input:focus {
            outline: none;
            border-color: var(--niue-yellow);
            background: var(--pale-yellow);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .save-btn {
            padding: 16px;
            background: var(--niue-blue);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 1px;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .save-btn:hover {
            background: var(--light-blue);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .next-btn {
            padding: 16px;
            background: var(--green);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 1px;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .next-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(34, 197, 94, 0.4);
        }

        .history-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 2px solid #f0f0f0;
        }

        .history-item {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
            position: relative;
        }

        .history-item.pr-session {
            background: linear-gradient(135deg, #fff9e6 0%, #fffbf0 100%);
            border: 2px solid #ffd700;
        }

        .history-date {
            font-weight: 600;
            color: var(--niue-blue);
            margin-bottom: 4px;
        }

        .history-sets {
            color: #666;
        }

        .history-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
        }

        .edit-history-btn {
            background: #e8f4f8;
            border: none;
            color: var(--light-blue);
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .edit-history-btn:hover {
            background: var(--light-blue);
            color: white;
        }

        .delete-history-btn {
            background: #fee;
            border: none;
            color: #c44;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .delete-history-btn:hover {
            background: #c44;
            color: white;
        }

        .mobility-section {
            background: white;
            margin: 0 20px 20px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 12px var(--shadow);
            border-left: 5px solid var(--niue-blue);
        }

        .mobility-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            color: var(--niue-blue);
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        .mobility-content {
            color: var(--light-blue);
            font-weight: 500;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .mobility-timer {
            background: var(--pale-yellow);
            padding: 16px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid var(--niue-yellow);
        }

        .mobility-timer-display {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 36px;
            color: var(--niue-blue);
            margin-bottom: 12px;
            letter-spacing: 1px;
        }

        .mobility-timer.active {
            background: var(--niue-blue);
            border-color: var(--niue-blue);
        }

        .mobility-timer.active .mobility-timer-display {
            color: var(--niue-yellow);
        }

        .exercise-log-list {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 12px var(--shadow);
            margin-bottom: 16px;
        }

        .log-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .log-list-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            color: var(--niue-blue);
            letter-spacing: 0.5px;
        }

        .filter-buttons {
            display: flex;
            gap: 6px;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 2px solid var(--niue-blue);
            background: white;
            color: var(--niue-blue);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: var(--niue-blue);
            color: white;
        }

        .log-entry {
            background: var(--pale-yellow);
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 4px solid var(--niue-yellow);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .log-entry:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .log-entry.pr-entry {
            border-left-color: #ffd700;
            background: linear-gradient(135deg, #fff9e6 0%, #fffbf0 100%);
        }

        .log-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .log-entry-name {
            font-weight: 700;
            color: var(--niue-blue);
            font-size: 16px;
        }

        .log-entry-date {
            font-size: 12px;
            color: #888;
            font-weight: 600;
        }

        .log-entry-details {
            font-size: 14px;
            color: var(--light-blue);
            margin-bottom: 8px;
        }

        .log-entry-stats {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: #666;
        }

        .log-entry-stats span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .pr-badge-inline {
            display: inline-block;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: var(--niue-blue);
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 8px;
            letter-spacing: 0.5px;
        }

        .no-history {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-style: italic;
        }

        .summary-content {
            text-align: center;
            padding: 40px 20px;
        }

        .summary-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .summary-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 32px;
            color: var(--niue-blue);
            margin-bottom: 16px;
            letter-spacing: 1px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 24px 0;
        }

        .summary-stat {
            background: var(--pale-yellow);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--niue-yellow);
        }

        .summary-stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 36px;
            color: var(--niue-blue);
            margin-bottom: 4px;
            letter-spacing: 1px;
        }

        .summary-stat-label {
            font-size: 12px;
            color: var(--light-blue);
            font-weight: 600;
            text-transform: uppercase;
        }

        .finish-btn {
            width: 100%;
            padding: 20px;
            background: var(--green);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 1px;
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.3);
            margin-top: 24px;
        }

        .finish-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(34, 197, 94, 0.4);
        }

        /* Strength Matrix Tier Colors */
        .tier-rookie { background: #e0e0e0; color: #666; }
        .tier-built { background: #d4edda; color: #155724; }
        .tier-strong { background: #cce5ff; color: #004085; }
        .tier-veteran { background: #d1ecf1; color: #0c5460; }
        .tier-elite { background: #f8d7da; color: #721c24; }

        /* Progress Bar */
        .progress-section {
            margin: 16px 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .progress-bar-bg {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .progress-bar-fill-matrix {
            height: 100%;
            background: linear-gradient(90deg, var(--niue-yellow) 0%, var(--niue-blue) 100%);
            transition: width 0.3s ease;
        }

        .next-goal {
            font-size: 11px;
            color: var(--light-blue);
            font-weight: 500;
        }

        /* Strength Score Card */
        .strength-score-card {
            background: linear-gradient(135deg, var(--niue-blue) 0%, var(--light-blue) 100%);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
            color: white;
        }

        .strength-score-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 64px;
            line-height: 1;
            margin-bottom: 8px;
            text-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .strength-score-label {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 1px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .strength-score-trend {
            font-size: 13px;
            font-weight: 500;
        }

        .accessory-badge {
            background: var(--pale-yellow);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            color: var(--light-blue);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="flag-accent"></div>
        <div class="header-content">
            <button id="backToHome" onclick="goHome()" style="background: rgba(255, 205, 0, 0.2); border: none; color: var(--niue-yellow); padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; display: none; transition: all 0.3s ease;">
                ‚Üê Home
            </button>
            <div class="app-title">Rugby Strength</div>
            <div class="session-timer" id="sessionTimer">00:00</div>
        </div>
        <div class="tab-navigation" id="tabNavigation" style="display: none;">
            <button class="tab-btn" onclick="switchTab('dayA')">Day A</button>
            <button class="tab-btn" onclick="switchTab('dayB')">Day B</button>
            <button class="tab-btn" onclick="switchTab('dayC')">Day C</button>
            <button class="tab-btn" onclick="switchTab('stats')">Stats</button>
            <button class="tab-btn" onclick="switchTab('history')">History</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Undo Container -->
    <div id="undoContainer" class="undo-container"></div>

    <!-- Home Tab -->
    <div id="homeTab" class="tab-content">
        <div style="padding: 20px;">
            <!-- Hero Section -->
            <div style="background: linear-gradient(135deg, var(--niue-blue) 0%, var(--light-blue) 100%); border-radius: 16px; padding: 40px 24px; text-align: center; margin-bottom: 24px; box-shadow: 0 4px 20px var(--shadow); position: relative; overflow: hidden;">
                <div style="font-size: 64px; margin-bottom: 16px;">üèâ</div>
                <div style="font-family: 'Bebas Neue', sans-serif; font-size: 42px; color: white; letter-spacing: 2px; margin-bottom: 8px;">Rugby Strength</div>
                <div style="color: var(--niue-yellow); font-weight: 600; font-size: 14px; letter-spacing: 1px;">TRACK ‚Ä¢ TRAIN ‚Ä¢ DOMINATE</div>
            </div>

            <!-- Navigation Cards -->
            <div style="display: grid; gap: 12px; margin-bottom: 24px;">
                <button onclick="goToDay('A')" style="padding: 20px; background: white; border: 2px solid var(--niue-yellow); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 12px var(--shadow); display: flex; justify-content: space-between; align-items: center;">
                    <div style="text-align: left;">
                        <div style="font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: var(--niue-blue); letter-spacing: 1px;">Day A</div>
                        <div style="font-size: 13px; color: var(--light-blue); font-weight: 500;">Leg Day</div>
                    </div>
                    <div style="font-size: 40px;">üí™</div>
                </button>

                <button onclick="goToDay('B')" style="padding: 20px; background: white; border: 2px solid var(--niue-blue); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 12px var(--shadow); display: flex; justify-content: space-between; align-items: center;">
                    <div style="text-align: left;">
                        <div style="font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: var(--niue-blue); letter-spacing: 1px;">Day B</div>
                        <div style="font-size: 13px; color: var(--light-blue); font-weight: 500;">Upper Body</div>
                    </div>
                    <div style="font-size: 40px;">üî•</div>
                </button>

                <button onclick="goToDay('C')" style="padding: 20px; background: white; border: 2px solid var(--green); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 12px var(--shadow); display: flex; justify-content: space-between; align-items: center;">
                    <div style="text-align: left;">
                        <div style="font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: var(--niue-blue); letter-spacing: 1px;">Day C</div>
                        <div style="font-size: 13px; color: var(--light-blue); font-weight: 500;">Accessory</div>
                    </div>
                    <div style="font-size: 40px;">‚ö°</div>
                </button>

                <button onclick="goToStats()" style="padding: 20px; background: linear-gradient(135deg, var(--niue-yellow) 0%, #c4961a 100%); border: none; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 12px var(--shadow); display: flex; justify-content: space-between; align-items: center;">
                    <div style="text-align: left;">
                        <div style="font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: white; letter-spacing: 1px;">View Stats</div>
                        <div style="font-size: 13px; color: var(--niue-blue); font-weight: 600;">Strength Matrix</div>
                    </div>
                    <div style="font-size: 40px;">üìä</div>
                </button>

                <button onclick="goToHistory()" style="padding: 20px; background: linear-gradient(135deg, var(--niue-blue) 0%, var(--light-blue) 100%); border: none; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 12px var(--shadow); display: flex; justify-content: space-between; align-items: center;">
                    <div style="text-align: left;">
                        <div style="font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: white; letter-spacing: 1px;">View History</div>
                        <div style="font-size: 13px; color: var(--niue-yellow); font-weight: 600;">All workouts & logs</div>
                    </div>
                    <div style="font-size: 40px;">üìä</div>
                </button>
            </div>

            <!-- Recent Activity -->
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 12px var(--shadow); border-left: 5px solid var(--niue-yellow);">
                <div style="font-family: 'Bebas Neue', sans-serif; font-size: 18px; color: var(--niue-blue); margin-bottom: 12px; letter-spacing: 0.5px;">Recent Activity</div>
                <div id="homeRecentActivity" style="font-size: 14px; color: var(--light-blue);"></div>
            </div>
        </div>
    </div>

    <!-- Workout Tab -->
    <div id="workoutTab" class="tab-content" style="display: none;">
        <div class="session-control">
            <button class="start-workout-btn" id="startWorkoutBtn" onclick="toggleWorkout()">
                Start Workout
            </button>
        </div>

        <div class="workout-progress" id="workoutProgress" style="display: none;">
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="progressText">0 / 8 exercises completed</div>
        </div>

        <div id="dayInfo" class="day-info"></div>
        <div id="exercisesList" class="exercises-list"></div>

        <div class="mobility-section">
            <div class="mobility-title">Mobility Work</div>
            <div id="mobilityContent" class="mobility-content"></div>
            <div class="mobility-timer" id="mobilityTimer">
                <div class="mobility-timer-display" id="mobilityTimerDisplay">00:45</div>
                <div class="rest-timer-controls">
                    <button class="timer-btn" onclick="startMobilityTimer()">Start Timer</button>
                    <button class="timer-btn" onclick="resetMobilityTimer()">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Tab -->
    <div id="statsTab" class="tab-content" style="display: none;">
        <div style="padding: 20px;">
            <!-- Strength Score Card - NEW -->
            <div class="strength-score-card" id="strengthScoreCard">
                <div class="strength-score-value" id="statsCoreScore">0</div>
                <div class="strength-score-label">CORE STRENGTH SCORE</div>
                <div class="strength-score-trend" id="statsScoreTrend">‚Üë 0 from last week</div>
                <div style="font-size: 12px; margin-top: 8px; opacity: 0.8;" id="statsAccessoryInfo"></div>
            </div>

            <!-- Quick Stats Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
                <button onclick="showWeeklyBreakdown()" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 12px var(--shadow); text-align: center; border: 2px solid var(--niue-yellow); cursor: pointer; transition: all 0.3s ease;">
                    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 36px; color: var(--niue-blue);" id="statsWeeklyWorkouts">0</div>
                    <div style="font-size: 11px; color: var(--light-blue); font-weight: 600; text-transform: uppercase; margin-bottom: 4px;">Workouts This Week</div>
                    <div style="font-size: 10px; color: #888;">Tap to view</div>
                </button>
                <button onclick="showPRList()" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 12px var(--shadow); text-align: center; border: 2px solid var(--niue-yellow); cursor: pointer; transition: all 0.3s ease;">
                    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 36px; color: var(--niue-blue);" id="statsTotalPRs">0</div>
                    <div style="font-size: 11px; color: var(--light-blue); font-weight: 600; text-transform: uppercase; margin-bottom: 4px;">Personal Records</div>
                    <div style="font-size: 10px; color: #888;">Tap to view</div>
                </button>
                <button onclick="showBestLifts()" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 12px var(--shadow); text-align: center; border: 2px solid var(--niue-blue); cursor: pointer; transition: all 0.3s ease;">
                    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 36px; color: var(--niue-blue);" id="statsBestLifts">0</div>
                    <div style="font-size: 11px; color: var(--light-blue); font-weight: 600; text-transform: uppercase; margin-bottom: 4px;">Best Lifts (1RM)</div>
                    <div style="font-size: 10px; color: #888;">Tap to view</div>
                </button>
                <button onclick="showAccessoryBreakdown()" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 12px var(--shadow); text-align: center; border: 2px solid var(--niue-blue); cursor: pointer; transition: all 0.3s ease;">
                    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 36px; color: var(--niue-blue);" id="statsAccessoryCount">0</div>
                    <div style="font-size: 11px; color: var(--light-blue); font-weight: 600; text-transform: uppercase; margin-bottom: 4px;">Accessory Lifts</div>
                    <div style="font-size: 10px; color: #888;">Tap to view</div>
                </button>
            </div>

            <!-- Weight Tracker -->
            <div class="weight-tracker-card" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 12px var(--shadow); margin-bottom: 24px;">
                <div style="font-family: 'Bebas Neue', sans-serif; font-size: 20px; color: var(--niue-blue); margin-bottom: 12px; letter-spacing: 0.5px;">‚öñÔ∏è Body Weight Tracker</div>
                <div id="statsCurrentWeightDisplay" style="text-align: center; padding: 16px; background: var(--pale-yellow); border-radius: 10px; margin-bottom: 16px;">
                    <div style="font-size: 12px; color: var(--light-blue); font-weight: 600; margin-bottom: 4px;">CURRENT WEIGHT</div>
                    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 48px; color: var(--niue-blue);" id="statsCurrentWeightValue">‚Äî</div>
                    <div style="font-size: 12px; color: #888;" id="statsCurrentWeightDate">No weight logged yet</div>
                </div>
                <div class="weight-input-section" style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <div class="weight-input-group" style="flex: 1;">
                        <div class="weight-input-label" style="font-size: 12px; color: #888; margin-bottom: 4px;">New Weight (kg)</div>
                        <input type="number" step="0.1" class="weight-input" id="statsWeightInput" placeholder="65.0" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>
                    <button class="weight-save-btn" onclick="saveWeight()" style="padding: 10px 20px; background: var(--niue-blue); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; align-self: flex-end;">Log</button>
                </div>
                <div>
                    <button onclick="toggleWeightHistory()" style="width: 100%; padding: 10px; background: transparent; border: 2px solid var(--niue-yellow); color: var(--niue-yellow); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">View History</button>
                    <div id="weightHistoryList" style="margin-top: 12px; display: none;"></div>
                </div>
            </div>

            <!-- STRENGTH MATRIX -->
            <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 12px var(--shadow);">
                <div style="font-family: 'Bebas Neue', sans-serif; font-size: 20px; color: var(--niue-blue); margin-bottom: 16px; letter-spacing: 0.5px;">üèâ RUGBY STRENGTH MATRIX (13-16)</div>
                <div id="strengthMatrixGrid"></div>
                <div id="accessoryBreakdown" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- History Tab -->
    <div id="historyTab" class="tab-content" style="display: none;">
        <div class="history-container">
            <!-- Stats Dashboard -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 20px 20px 24px;">
                <button onclick="showWeeklyBreakdown()" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 12px var(--shadow); text-align: center; border: 2px solid var(--niue-yellow); cursor: pointer; transition: all 0.3s ease;">
                    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 36px; color: var(--niue-blue);" id="historyWeeklyWorkouts">0</div>
                    <div style="font-size: 11px; color: var(--light-blue); font-weight: 600; text-transform: uppercase; margin-bottom: 4px;">Workouts This Week</div>
                    <div style="font-size: 10px; color: #888;">Tap to view</div>
                </button>
                <button onclick="showPRList()" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 12px var(--shadow); text-align: center; border: 2px solid var(--niue-yellow); cursor: pointer; transition: all 0.3s ease;">
                    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 36px; color: var(--niue-blue);" id="historyTotalPRs">0</div>
                    <div style="font-size: 11px; color: var(--light-blue); font-weight: 600; text-transform: uppercase; margin-bottom: 4px;">Personal Records</div>
                    <div style="font-size: 10px; color: #888;">Tap to view</div>
                </button>
                <button onclick="showBestLifts()" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 12px var(--shadow); text-align: center; border: 2px solid var(--niue-blue); cursor: pointer; transition: all 0.3s ease;">
                    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 36px; color: var(--niue-blue);" id="historyBestLifts">0</div>
                    <div style="font-size: 11px; color: var(--light-blue); font-weight: 600; text-transform: uppercase; margin-bottom: 4px;">Best Lifts (1RM)</div>
                    <div style="font-size: 10px; color: #888;">Tap to view</div>
                </button>
                <button onclick="showAccessoryBreakdown()" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 12px var(--shadow); text-align: center; border: 2px solid var(--niue-blue); cursor: pointer; transition: all 0.3s ease;">
                    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 36px; color: var(--niue-blue);" id="historyAccessoryCount">0</div>
                    <div style="font-size: 11px; color: var(--light-blue); font-weight: 600; text-transform: uppercase; margin-bottom: 4px;">Accessory Lifts</div>
                    <div style="font-size: 10px; color: #888;">Tap to view</div>
                </button>
            </div>

            <div class="exercise-log-list">
                <div class="log-list-header">
                    <div class="log-list-title">Exercise Log</div>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterLog('all')">All</button>
                        <button class="filter-btn" onclick="filterLog('dayA')">Day A</button>
                        <button class="filter-btn" onclick="filterLog('dayB')">Day B</button>
                        <button class="filter-btn" onclick="filterLog('dayC')">Day C</button>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button onclick="exportData()" style="flex: 1; padding: 12px; background: var(--niue-blue); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        üì• Export Data
                    </button>
                    <button onclick="importData()" style="flex: 1; padding: 12px; background: var(--light-blue); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        üì§ Import Data
                    </button>
                </div>
                <div id="exerciseLogContent"></div>
            </div>
        </div>
    </div>

    <!-- Exercise Modal -->
    <div id="exerciseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close-btn" onclick="closeModal()">√ó</button>
                <div class="modal-title" id="modalExerciseName"></div>
                <div class="modal-subtitle" id="modalExerciseTarget"></div>
            </div>
            <div class="modal-body">
                <div id="viewOnlyNotice" class="view-only-notice" style="display: none;">
                    <strong>üëÄ View Only Mode</strong>
                    <p>Start your workout to log exercises</p>
                </div>

                <div class="rest-timer-section" id="restTimer">
                    <div class="rest-timer-display" id="restTimerDisplay">01:30</div>
                    <div class="rest-timer-controls">
                        <button class="timer-btn" onclick="setRestTimer(60)">60s</button>
                        <button class="timer-btn" onclick="setRestTimer(90)">90s</button>
                        <button class="timer-btn" onclick="setRestTimer(120)">120s</button>
                        <button class="timer-btn" id="restTimerBtn" onclick="toggleRestTimer()">Start</button>
                    </div>
                </div>

                <div id="prefillSection" class="prefill-section" style="display: none;">
                    <div class="prefill-title">üìã Last Workout</div>
                    <div class="prefill-data" id="prefillData"></div>
                    <button class="prefill-btn" onclick="prefillLastWorkout()">Use These Weights</button>
                </div>

                <div class="section-title">Today's Sets</div>
                <div id="setsContainer" class="sets-container"></div>
                
                <button class="add-set-btn" id="addSetBtn" onclick="addSet()">+ Add Another Set</button>

                <div class="stats-grid">
                    <div class="stat-card" id="card1RM">
                        <div class="stat-label">Est. 1RM</div>
                        <div class="stat-value" id="estimated1RM">‚Äî</div>
                        <div class="stat-comparison" id="comparison1RM"></div>
                    </div>
                    <div class="stat-card" id="cardVolume">
                        <div class="stat-label">Total Volume</div>
                        <div class="stat-value" id="totalVolume">‚Äî</div>
                        <div class="stat-comparison" id="comparisonVolume"></div>
                    </div>
                </div>

                <div class="notes-section">
                    <div class="section-title">Notes</div>
                    <textarea class="notes-input" id="exerciseNotes" placeholder="How did this feel? Any adjustments needed?"></textarea>
                </div>

                <div class="action-buttons" id="actionButtons">
                    <button class="save-btn" onclick="saveWorkout()">Save</button>
                    <button class="next-btn" onclick="saveAndNext()">Save & Next ‚Üí</button>
                </div>

                <div class="history-section">
                    <div class="section-title">Recent History</div>
                    <div id="historyContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Summary Modal -->
    <div id="summaryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close-btn" onclick="closeSummary()">√ó</button>
                <div class="modal-title">Workout Complete!</div>
            </div>
            <div class="modal-body">
                <div class="summary-content">
                    <div class="summary-icon">üèâ</div>
                    <div class="summary-title">Great Session!</div>
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <div class="summary-stat-value" id="summaryDuration">‚Äî</div>
                            <div class="summary-stat-label">Duration</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value" id="summaryExercises">‚Äî</div>
                            <div class="summary-stat-label">Exercises</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value" id="summaryVolume">‚Äî</div>
                            <div class="summary-stat-label">Total Volume</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value" id="summarySets">‚Äî</div>
                            <div class="summary-stat-label">Total Sets</div>
                        </div>
                    </div>
                    <button class="finish-btn" onclick="finishWorkout()">Finish</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // WORKOUT DATA
        // ============================================
        const workoutData = {
            A: {
                title: "Day A - Leg Day",
                description: "Build foundation strength üí™",
                mobility: "Leg swings, hip circles, bodyweight squats",
                exercises: [
                    { name: "Zercher Squat", sets: 3, reps: 8 },
                    { name: "Romanian Deadlift", sets: 3, reps: 8 },
                    { name: "Incline DB Bench Press", sets: 3, reps: 10 },
                    { name: "Lat Pulldown", sets: 3, reps: 10 },
                    { name: "Hanging Knee Raises", sets: 2, reps: "10-15" }
                ]
            },
            B: {
                title: "Day B - Upper Body Power",
                description: "Build tackle strength üí™",
                mobility: "Arm circles, band pull-aparts, cat-cow",
                exercises: [
                    { name: "Deadlift", sets: 3, reps: 5 },
                    { name: "Zercher Step-Ups", sets: 3, reps: "6/side" },
                    { name: "Barbell Bench Press", sets: 3, reps: "6-8" },
                    { name: "Barbell Shoulder Press", sets: 3, reps: 8 },
                    { name: "Bent-Over Barbell Row", sets: 3, reps: 8 },
                    { name: "Plank Pull-Through", sets: 2, reps: "8-10/side" }
                ]
            },
            C: {
                title: "Day C - Accessory & Recovery",
                description: "Stay healthy and mobile ‚ö°",
                mobility: "Full body dynamic warm-up",
                exercises: [
                    { name: "Lateral Lunge", sets: 3, reps: "8-10/side" },
                    { name: "Bent Knee Calf Raises", sets: 3, reps: "15-20" },
                    { name: "Face Pulls", sets: 3, reps: 15 },
                    { name: "4-Way Neck", sets: 3, reps: "12-15 each direction" }
                ]
            }
        };

        // ============================================
        // TEEN RUGBY STRENGTH MATRIX (Ages 13-16)
        // ============================================
        const strengthMatrix = {
            'Zercher Squat': { rookie: 30, built: 45, strong: 60, veteran: 75, elite: 90 },
            'Bench Press': { rookie: 30, built: 40, strong: 50, veteran: 60, elite: 80 },
            'Deadlift': { rookie: 40, built: 60, strong: 80, veteran: 100, elite: 120 },
            'Shoulder Press': { rookie: 10, built: 20, strong: 30, veteran: 40, elite: 50 },
            'Lat Pulldown': { rookie: 20, built: 35, strong: 50, veteran: 65, elite: 80 },
            'Barbell Row': { rookie: 20, built: 30, strong: 45, veteran: 60, elite: 75 },
            // Include variations (these will be ACCESSORIES, not core)
            'Incline DB Bench Press': { rookie: 25, built: 35, strong: 45, veteran: 55, elite: 70 },
            'Romanian Deadlift': { rookie: 30, built: 45, strong: 60, veteran: 75, elite: 90 }
        };

        // ============================================
        // CORE LIFTS FOR STRENGTH SCORE
        // ============================================
        const coreLifts = [
            'Zercher Squat',
            'Bench Press',
            'Deadlift',
            'Shoulder Press',
            'Lat Pulldown',
            'Barbell Row'
        ];

        // ============================================
        // STRENGTH SCORE FUNCTIONS
        // ============================================
        function calculateCoreStrengthScore(history) {
            if (history.length === 0) return 0;
            
            const exerciseBest = {};
            
            history.forEach(workout => {
                const exercise = workout.exercise;
                const max1RM = Math.max(...workout.sets.map(s => calculate1RM(s.weight, s.reps)));
                
                // Check if this is a core lift
                if (coreLifts.includes(exercise)) {
                    if (!exerciseBest[exercise] || max1RM > exerciseBest[exercise]) {
                        exerciseBest[exercise] = max1RM;
                    }
                }
            });
            
            let totalScore = 0;
            coreLifts.forEach(lift => {
                if (exerciseBest[lift]) {
                    totalScore += exerciseBest[lift];
                }
            });
            
            return Math.round(totalScore);
        }

        function calculateAccessoryScore(history) {
            if (history.length === 0) return { total: 0, count: 0, details: {} };
            
            const accessoryBest = {};
            
            history.forEach(workout => {
                const exercise = workout.exercise;
                const max1RM = Math.max(...workout.sets.map(s => calculate1RM(s.weight, s.reps)));
                
                // If it's NOT a core lift, it's an accessory
                if (!coreLifts.includes(exercise)) {
                    if (!accessoryBest[exercise] || max1RM > accessoryBest[exercise]) {
                        accessoryBest[exercise] = max1RM;
                    }
                }
            });
            
            let totalScore = 0;
            Object.values(accessoryBest).forEach(weight => {
                totalScore += weight;
            });
            
            return {
                total: Math.round(totalScore),
                count: Object.keys(accessoryBest).length,
                details: accessoryBest
            };
        }

        function calculateStrengthScoreProgress(history) {
            const coreScore = calculateCoreStrengthScore(history);
            
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            const recentHistory = history.filter(w => new Date(w.date) >= oneWeekAgo);
            const recentCoreScore = calculateCoreStrengthScore(recentHistory);
            
            return {
                current: coreScore,
                weekly: recentCoreScore,
                weeklyChange: coreScore - recentCoreScore
            };
        }

        // ============================================
        // STRENGTH MATRIX FUNCTIONS
        // ============================================
        function getTierAndProgress(currentWeight, exerciseName) {
            let standards = null;
            
            // Map exercise names to matrix keys
            if (strengthMatrix[exerciseName]) {
                standards = strengthMatrix[exerciseName];
            } else if (exerciseName.includes('Zercher')) {
                standards = strengthMatrix['Zercher Squat'];
            } else if (exerciseName.includes('Bench Press')) {
                standards = strengthMatrix['Bench Press'];
            } else if (exerciseName.includes('Deadlift')) {
                standards = strengthMatrix['Deadlift'];
            } else if (exerciseName.includes('Shoulder Press')) {
                standards = strengthMatrix['Shoulder Press'];
            } else if (exerciseName.includes('Lat Pulldown')) {
                standards = strengthMatrix['Lat Pulldown'];
            } else if (exerciseName.includes('Row')) {
                standards = strengthMatrix['Barbell Row'];
            } else if (exerciseName.includes('Romanian')) {
                standards = strengthMatrix['Romanian Deadlift'];
            } else if (exerciseName.includes('Incline')) {
                standards = strengthMatrix['Incline DB Bench Press'];
            }
            
            if (!standards) return null;
            
            if (currentWeight >= standards.elite) {
                return { 
                    tier: 'ELITE', 
                    progress: 100, 
                    next: null, 
                    current: standards.elite,
                    nextTier: null,
                    color: '#f8d7da',
                    textColor: '#721c24'
                };
            }
            if (currentWeight >= standards.veteran) {
                const progress = ((currentWeight - standards.veteran) / (standards.elite - standards.veteran)) * 100;
                return { 
                    tier: 'VETERAN', 
                    progress: Math.min(progress, 100), 
                    next: standards.elite,
                    current: standards.veteran,
                    nextTier: 'ELITE',
                    color: '#d1ecf1',
                    textColor: '#0c5460'
                };
            }
            if (currentWeight >= standards.strong) {
                const progress = ((currentWeight - standards.strong) / (standards.veteran - standards.strong)) * 100;
                return { 
                    tier: 'STRONG', 
                    progress: Math.min(progress, 100), 
                    next: standards.veteran,
                    current: standards.strong,
                    nextTier: 'VETERAN',
                    color: '#cce5ff',
                    textColor: '#004085'
                };
            }
            if (currentWeight >= standards.built) {
                const progress = ((currentWeight - standards.built) / (standards.strong - standards.built)) * 100;
                return { 
                    tier: 'BUILT', 
                    progress: Math.min(progress, 100), 
                    next: standards.strong,
                    current: standards.built,
                    nextTier: 'STRONG',
                    color: '#d4edda',
                    textColor: '#155724'
                };
            }
            
            const progress = (currentWeight / standards.built) * 100;
            return { 
                tier: 'ROOKIE', 
                progress: Math.min(progress, 100), 
                next: standards.built,
                current: 0,
                nextTier: 'BUILT',
                color: '#e0e0e0',
                textColor: '#666'
            };
        }

        function renderStrengthMatrix() {
            const workoutHistory = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const container = document.getElementById('strengthMatrixGrid');
            
            // Get best 1RM for each core lift
            const exerciseBest = {};
            
            workoutHistory.forEach(workout => {
                const exercise = workout.exercise;
                const max1RM = Math.max(...workout.sets.map(s => calculate1RM(s.weight, s.reps)));
                
                // Only track core lifts in the matrix
                if (coreLifts.includes(exercise)) {
                    if (!exerciseBest[exercise] || max1RM > exerciseBest[exercise]) {
                        exerciseBest[exercise] = max1RM;
                    }
                }
            });
            
            // Check if any core lifts have data
            const hasData = coreLifts.some(lift => exerciseBest[lift]);
            
            if (!hasData) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üí™</div>
                        <div style="font-family: 'Bebas Neue', sans-serif; font-size: 20px; color: var(--niue-blue); margin-bottom: 8px;">No Core Lift Data Yet</div>
                        <div style="color: #888; font-size: 14px;">Log your main lifts (Zercher, Bench, Deadlift, etc.) to see your Strength Matrix</div>
                    </div>
                `;
                return;
            }
            
            // Legend
            let html = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; padding: 12px; background: var(--pale-yellow); border-radius: 12px;">
                        <span style="display: flex; align-items: center; gap: 4px; font-size: 12px;"><span style="background: #e0e0e0; width: 12px; height: 12px; border-radius: 3px;"></span> Rookie</span>
                        <span style="display: flex; align-items: center; gap: 4px; font-size: 12px;"><span style="background: #d4edda; width: 12px; height: 12px; border-radius: 3px;"></span> Built</span>
                        <span style="display: flex; align-items: center; gap: 4px; font-size: 12px;"><span style="background: #cce5ff; width: 12px; height: 12px; border-radius: 3px;"></span> Strong</span>
                        <span style="display: flex; align-items: center; gap: 4px; font-size: 12px;"><span style="background: #d1ecf1; width: 12px; height: 12px; border-radius: 3px;"></span> Veteran</span>
                        <span style="display: flex; align-items: center; gap: 4px; font-size: 12px;"><span style="background: #f8d7da; width: 12px; height: 12px; border-radius: 3px;"></span> Elite</span>
                    </div>
                </div>
            `;
            
            // Icons for lifts
            const liftIcons = {
                'Zercher Squat': 'ü¶µ',
                'Bench Press': 'üèãÔ∏è',
                'Deadlift': 'üí™',
                'Shoulder Press': 'üèãÔ∏è',
                'Lat Pulldown': '‚¨áÔ∏è',
                'Barbell Row': '‚õìÔ∏è'
            };
            
            coreLifts.forEach(lift => {
                const best = exerciseBest[lift] || 0;
                if (best === 0) return;
                
                const result = getTierAndProgress(best, lift);
                if (!result) return;
                
                const icon = liftIcons[lift] || 'üèãÔ∏è';
                
                html += `
                    <div style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; border-left: 4px solid ${result.color}; box-shadow: 0 2px 8px var(--shadow);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">${icon}</span>
                                <span style="font-weight: 600; color: var(--niue-blue);">${lift}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-family: 'Bebas Neue', sans-serif; font-size: 24px; color: var(--niue-blue);">${best}kg</span>
                                <span style="background: ${result.color}; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; color: ${result.textColor};">${result.tier}</span>
                            </div>
                        </div>
                        
                        ${result.next ? `
                            <div class="progress-section">
                                <div class="progress-label">
                                    <span style="font-size: 11px;">Need ${Math.max(0, (result.next - best)).toFixed(1)}kg more</span>
                                    <span style="font-size: 11px;">Next: ${result.nextTier} (${result.next}kg)</span>
                                </div>
                                <div class="progress-bar-bg">
                                    <div class="progress-bar-fill-matrix" style="width: ${result.progress}%;"></div>
                                </div>
                            </div>
                        ` : `
                            <div style="font-size: 12px; color: #721c24; font-weight: 600; margin-top: 4px; text-align: center; padding: 8px; background: #f8d7da; border-radius: 8px;">
                                üèÜ ELITE! üèÜ
                            </div>
                        `}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderAccessoryBreakdown(history) {
            const accessoryData = calculateAccessoryScore(history);
            const container = document.getElementById('accessoryBreakdown');
            
            if (!container) return;
            
            if (accessoryData.count === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = `
                <div style="margin-top: 24px; padding: 16px; background: var(--pale-yellow); border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="font-weight: 600; color: var(--niue-blue);">Accessory Lifts</div>
                        <span class="accessory-badge">${accessoryData.count} lifts ‚Ä¢ ${accessoryData.total}kg</span>
                    </div>
            `;
            
            Object.entries(accessoryData.details)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .forEach(([name, weight]) => {
                    html += `
                        <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 6px; padding: 4px 0; border-bottom: 1px dashed #ddd;">
                            <span>${name}</span>
                            <span style="font-weight: 600;">${weight}kg</span>
                        </div>
                    `;
                });
            
            if (accessoryData.count > 5) {
                html += `<div style="font-size: 11px; color: #888; margin-top: 8px; text-align: center;">+${accessoryData.count - 5} more lifts</div>`;
            }
            
            html += `</div>`;
            container.innerHTML = html;
        }

        // ============================================
        // RENDER STATS
        // ============================================
        function renderStats() {
            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const thisWeek = getThisWeekWorkouts(history);
            const lastWeek = getLastWeekWorkouts(history);
            
            // Calculate scores
            const coreScore = calculateCoreStrengthScore(history);
            const accessoryData = calculateAccessoryScore(history);
            const progress = calculateStrengthScoreProgress(history);
            
            // Weekly workout count
            const thisWeekCount = new Set(thisWeek.map(w => new Date(w.date).toDateString())).size;
            const lastWeekCount = new Set(lastWeek.map(w => new Date(w.date).toDateString())).size;
            
            // PR count
            const allPRs = countPRs(history);
            
            // Best lifts count
            const uniqueExercises = new Set(history.map(w => w.exercise)).size;
            
            // Update DOM
            document.getElementById('statsCoreScore').textContent = coreScore;
            document.getElementById('statsWeeklyWorkouts').textContent = thisWeekCount;
            document.getElementById('statsTotalPRs').textContent = allPRs;
            document.getElementById('statsBestLifts').textContent = uniqueExercises;
            document.getElementById('statsAccessoryCount').textContent = accessoryData.count;
            document.getElementById('statsAccessoryInfo').textContent = `+${accessoryData.total}kg from ${accessoryData.count} accessories`;
            
            // Trend
            let trendText = progress.weeklyChange > 0 
                ? `‚Üë ${progress.weeklyChange} from last week` 
                : progress.weeklyChange < 0 
                    ? `‚Üì ${Math.abs(progress.weeklyChange)} from last week` 
                    : 'Same as last week';
            document.getElementById('statsScoreTrend').textContent = trendText;
            document.getElementById('statsScoreTrend').style.color = progress.weeklyChange > 0 ? 'var(--green)' : progress.weeklyChange < 0 ? 'var(--red)' : 'rgba(255,255,255,0.8)';
            
            // Also update history tab stats
            document.getElementById('historyWeeklyWorkouts').textContent = thisWeekCount;
            document.getElementById('historyTotalPRs').textContent = allPRs;
            document.getElementById('historyBestLifts').textContent = uniqueExercises;
            document.getElementById('historyAccessoryCount').textContent = accessoryData.count;
            
            displayCurrentWeight();
            renderStrengthMatrix();
            renderAccessoryBreakdown(history);
        }

        // ============================================
        // HISTORY STACK FOR BACK BUTTON
        // ============================================
        const historyStack = {
            stack: ['home'],
            currentIndex: 0,
            
            push(state) {
                if (this.currentIndex < this.stack.length - 1) {
                    this.stack = this.stack.slice(0, this.currentIndex + 1);
                }
                this.stack.push(state);
                this.currentIndex = this.stack.length - 1;
            },
            
            replace(state) {
                this.stack[this.currentIndex] = state;
            },
            
            back() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    return this.stack[this.currentIndex];
                }
                return null;
            },
            
            getCurrent() {
                return this.stack[this.currentIndex];
            },
            
            canGoBack() {
                return this.currentIndex > 0;
            }
        };

        // ============================================
        // ANDROID BACK BUTTON HANDLER
        // ============================================
        window.addEventListener('popstate', function(event) {
            event.preventDefault();
            
            const exerciseModal = document.getElementById('exerciseModal');
            const summaryModal = document.getElementById('summaryModal');
            
            // Priority 1: Close open modals
            if (exerciseModal && exerciseModal.classList.contains('active')) {
                closeModal();
                return;
            }
            
            if (summaryModal && summaryModal.classList.contains('active')) {
                closeSummary();
                return;
            }
            
            // Priority 2: Close session detail views
            const sessionDetail = document.getElementById('sessionDetailContent');
            if (sessionDetail) {
                sessionDetail.remove();
                document.querySelector('.close-btn').style.display = 'block';
                const sectionTitles = document.querySelectorAll('.section-title');
                sectionTitles.forEach(title => title.style.display = 'block');
                document.getElementById('setsContainer').style.display = 'block';
                document.querySelector('.history-section').style.display = 'block';
                historyStack.back();
                return;
            }
            
            // Priority 3: Navigate back in history
            const previousState = historyStack.back();
            
            if (!previousState) {
                // No more history - check for active workout before letting Android close
                if (workoutActive) {
                    if (confirm('You have an active workout. Exit app?')) {
                        finishWorkout();
                        return;
                    } else {
                        history.pushState({ page: getCurrentPage(), timestamp: Date.now() }, '', '');
                        historyStack.push(getCurrentPage());
                        return;
                    }
                }
                return; // Let Android close the app
            }
            
            // Navigate to previous state
            navigateToPage(previousState);
            return false;
        }, false);

        // ============================================
        // NAVIGATION FUNCTIONS
        // ============================================
        function navigateToPage(page) {
            const sessionDetail = document.getElementById('sessionDetailContent');
            if (sessionDetail) sessionDetail.remove();
            
            switch(page) {
                case 'home':
                    document.getElementById('homeTab').style.display = 'block';
                    document.getElementById('workoutTab').style.display = 'none';
                    document.getElementById('statsTab').style.display = 'none';
                    document.getElementById('historyTab').style.display = 'none';
                    document.getElementById('tabNavigation').style.display = 'none';
                    document.getElementById('backToHome').style.display = 'none';
                    renderHome();
                    break;
                    
                case 'workout':
                    document.getElementById('homeTab').style.display = 'none';
                    document.getElementById('workoutTab').style.display = 'block';
                    document.getElementById('statsTab').style.display = 'none';
                    document.getElementById('historyTab').style.display = 'none';
                    document.getElementById('tabNavigation').style.display = 'flex';
                    document.getElementById('backToHome').style.display = 'block';
                    renderDay();
                    break;
                    
                case 'stats':
                    document.getElementById('homeTab').style.display = 'none';
                    document.getElementById('workoutTab').style.display = 'none';
                    document.getElementById('statsTab').style.display = 'block';
                    document.getElementById('historyTab').style.display = 'none';
                    document.getElementById('tabNavigation').style.display = 'flex';
                    document.getElementById('backToHome').style.display = 'block';
                    renderStats();
                    break;
                    
                case 'history':
                    document.getElementById('homeTab').style.display = 'none';
                    document.getElementById('workoutTab').style.display = 'none';
                    document.getElementById('statsTab').style.display = 'none';
                    document.getElementById('historyTab').style.display = 'block';
                    document.getElementById('tabNavigation').style.display = 'flex';
                    document.getElementById('backToHome').style.display = 'block';
                    renderHistory();
                    break;
            }
            
            updateTabButtons(page);
        }

        function updateTabButtons(page) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            if (page === 'workout') {
                if (currentDay === 'A') {
                    document.querySelectorAll('.tab-btn')[0]?.classList.add('active');
                } else if (currentDay === 'B') {
                    document.querySelectorAll('.tab-btn')[1]?.classList.add('active');
                } else if (currentDay === 'C') {
                    document.querySelectorAll('.tab-btn')[2]?.classList.add('active');
                }
            } else if (page === 'stats') {
                document.querySelectorAll('.tab-btn')[3]?.classList.add('active');
            } else if (page === 'history') {
                document.querySelectorAll('.tab-btn')[4]?.classList.add('active');
            }
        }

        function getCurrentPage() {
            if (document.getElementById('homeTab').style.display === 'block') return 'home';
            if (document.getElementById('workoutTab').style.display === 'block') return 'workout';
            if (document.getElementById('statsTab').style.display === 'block') return 'stats';
            if (document.getElementById('historyTab').style.display === 'block') return 'history';
            return 'home';
        }

        function goHome() {
            if (workoutActive) {
                if (!confirm('End your current workout and return to home?')) return;
                finishWorkout();
            }
            
            history.pushState({ page: 'home', timestamp: Date.now() }, '', '');
            historyStack.push('home');
            navigateToPage('home');
        }

        function goToDay(day) {
            currentDay = day;
            history.pushState({ page: 'workout', day: day, timestamp: Date.now() }, '', '');
            historyStack.push('workout');
            navigateToPage('workout');
        }

        function goToStats() {
            history.pushState({ page: 'stats', timestamp: Date.now() }, '', '');
            historyStack.push('stats');
            navigateToPage('stats');
        }

        function goToHistory() {
            history.pushState({ page: 'history', timestamp: Date.now() }, '', '');
            historyStack.push('history');
            navigateToPage('history');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (tab === 'dayA' || tab === 'dayB' || tab === 'dayC') {
                if (tab === 'dayA') currentDay = 'A';
                else if (tab === 'dayB') currentDay = 'B';
                else if (tab === 'dayC') currentDay = 'C';
                
                if (getCurrentPage() !== 'workout') {
                    goToDay(currentDay);
                } else {
                    renderDay();
                }
            } else if (tab === 'stats') {
                if (getCurrentPage() !== 'stats') {
                    goToStats();
                } else {
                    renderStats();
                }
            } else if (tab === 'history') {
                if (getCurrentPage() !== 'history') {
                    goToHistory();
                } else {
                    renderHistory();
                }
            }
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            
            setTimeout(() => {
                toast.className = 'toast';
            }, duration);
        }

        function calculate1RM(weight, reps) {
            if (reps <= 1) return weight;
            if (reps > 10) return 0;
            return Math.round(weight * (36 / (37 - reps)));
        }

        function validateWorkoutInputs(sets) {
            for (const set of sets) {
                if (set.weight <= 0) {
                    throw new Error('Weight must be positive');
                }
                if (set.reps <= 0 || set.reps > 100) {
                    throw new Error('Reps must be between 1-100');
                }
                if (!Number.isInteger(set.reps)) {
                    throw new Error('Reps must be whole numbers');
                }
            }
        }

        function showUndo(data) {
            const undoContainer = document.getElementById('undoContainer');
            lastDeletedWorkout = data;
            
            undoContainer.innerHTML = `
                <button class="undo-btn" onclick="undoDelete()">
                    ‚Ü∫ Undo Delete
                </button>
            `;
            
            if (undoTimeout) clearTimeout(undoTimeout);
            
            undoTimeout = setTimeout(() => {
                undoContainer.innerHTML = '';
                lastDeletedWorkout = null;
            }, 10000);
        }

        function undoDelete() {
            if (lastDeletedWorkout) {
                let history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
                history.push(lastDeletedWorkout);
                localStorage.setItem('workoutHistory', JSON.stringify(history));
                
                document.getElementById('undoContainer').innerHTML = '';
                showToast('‚úÖ Delete undone', 'success');
                lastDeletedWorkout = null;
                
                if (undoTimeout) clearTimeout(undoTimeout);
                
                renderHistory();
                renderDay();
                if (document.getElementById('statsTab').style.display !== 'none') {
                    renderStats();
                }
            }
        }

        // ============================================
        // SESSION PERSISTENCE
        // ============================================
        function startAutoSave() {
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            
            autoSaveInterval = setInterval(() => {
                if (workoutActive) {
                    saveSessionState();
                }
            }, 5000);
        }

        function saveSessionState() {
            const sessionState = {
                active: workoutActive,
                day: currentDay,
                startTime: sessionStartTime,
                currentExerciseIndex: currentExerciseIndex,
                timestamp: Date.now()
            };
            localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(sessionState));
        }

        function loadSessionState() {
            const savedState = localStorage.getItem(SESSION_STORAGE_KEY);
            if (!savedState) return null;
            
            try {
                const state = JSON.parse(savedState);
                if (Date.now() - state.timestamp > SESSION_TIMEOUT) {
                    localStorage.removeItem(SESSION_STORAGE_KEY);
                    return null;
                }
                return state;
            } catch (e) {
                return null;
            }
        }

        function clearSessionState() {
            localStorage.removeItem(SESSION_STORAGE_KEY);
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
        }

        function resumeSession(state) {
            currentDay = state.day;
            sessionStartTime = state.startTime;
            currentExerciseIndex = state.currentExerciseIndex || 0;
            
            goToDay(currentDay);
            
            workoutActive = true;
            const btn = document.getElementById('startWorkoutBtn');
            const timer = document.getElementById('sessionTimer');
            const progress = document.getElementById('workoutProgress');
            
            btn.textContent = 'End Workout';
            btn.classList.add('active');
            timer.classList.add('active');
            progress.style.display = 'block';
            
            sessionInterval = setInterval(updateSessionTimer, 1000);
            startAutoSave();
            updateProgress();
        }

        function showResumePrompt() {
            const state = loadSessionState();
            if (!state || !state.active) return;
            
            const elapsed = Math.floor((Date.now() - state.startTime) / 60000);
            
            if (confirm(`You have an active Day ${state.day} workout from ${elapsed} minutes ago. Resume it?`)) {
                resumeSession(state);
            } else {
                clearSessionState();
            }
        }

        // ============================================
        // WEIGHT TRACKING
        // ============================================
        function saveWeight() {
            const weightInput = document.getElementById('statsWeightInput');
            const weight = parseFloat(weightInput.value);
            
            if (!weight || weight <= 0) {
                showToast('Please enter a valid weight!', 'error');
                return;
            }
            
            if (weight > 150) {
                showToast('ü§î That seems a bit high for your age - check your number!', 'error');
                return;
            }
            
            let weightHistory = JSON.parse(localStorage.getItem('weightHistory') || '[]');
            weightHistory.push({ 
                weight: weight, 
                date: new Date().toISOString(), 
                id: Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9) 
            });
            localStorage.setItem('weightHistory', JSON.stringify(weightHistory));
            weightInput.value = '';
            
            displayCurrentWeight();
            showToast('‚úÖ Weight logged!', 'success');
        }

        function displayCurrentWeight() {
            const weightHistory = JSON.parse(localStorage.getItem('weightHistory') || '[]');
            if (weightHistory.length === 0) {
                document.getElementById('statsCurrentWeightValue').textContent = '‚Äî';
                document.getElementById('statsCurrentWeightDate').textContent = 'No weight logged yet';
                return;
            }
            const current = weightHistory.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
            document.getElementById('statsCurrentWeightValue').textContent = current.weight.toFixed(1) + 'kg';
            const daysAgo = Math.floor((Date.now() - new Date(current.date).getTime()) / (1000 * 60 * 60 * 24));
            let dateText = daysAgo === 0 ? 'Logged today' : daysAgo === 1 ? 'Logged yesterday' : daysAgo < 7 ? `Logged ${daysAgo} days ago` : `Logged ${new Date(current.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            document.getElementById('statsCurrentWeightDate').textContent = dateText;
        }

        function toggleWeightHistory() {
            const historyList = document.getElementById('weightHistoryList');
            if (historyList.style.display !== 'none') { 
                historyList.style.display = 'none'; 
                return; 
            }
            
            const weightHistory = JSON.parse(localStorage.getItem('weightHistory') || '[]');
            if (weightHistory.length === 0) { 
                historyList.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No weight entries yet</div>'; 
                historyList.style.display = 'block'; 
                return; 
            }
            
            const recent = weightHistory.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            historyList.innerHTML = recent.map(entry => {
                const dateStr = new Date(entry.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: new Date(entry.date).getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined });
                return `<div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee;"><span>${dateStr}</span><span style="font-weight: 600;">${entry.weight.toFixed(1)}kg</span></div>`;
            }).join('');
            historyList.style.display = 'block';
        }

        // ============================================
        // WORKOUT FUNCTIONS
        // ============================================
        function renderHome() {
            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            
            const recentWorkouts = history
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            if (recentWorkouts.length === 0) {
                document.getElementById('homeRecentActivity').innerHTML = 
                    '<div style="color: #999; font-style: italic; text-align: center; padding: 20px;">No workouts yet. Start your first session!</div>';
            } else {
                const grouped = {};
                recentWorkouts.forEach(workout => {
                    const dateKey = new Date(workout.date).toDateString();
                    if (!grouped[dateKey]) {
                        grouped[dateKey] = {
                            date: workout.date,
                            day: workout.day,
                            count: 0
                        };
                    }
                    grouped[dateKey].count++;
                });
                
                document.getElementById('homeRecentActivity').innerHTML = Object.values(grouped)
                    .map(session => {
                        const date = new Date(session.date);
                        const isToday = date.toDateString() === new Date().toDateString();
                        const dateStr = isToday ? 'Today' : date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        
                        return `
                            <div style="padding: 12px; background: var(--pale-yellow); border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: var(--niue-blue);">${dateStr}</div>
                                    <div style="font-size: 13px; color: #888;">${session.count} exercises logged</div>
                                </div>
                                <div style="background: var(--niue-blue); color: white; padding: 4px 12px; border-radius: 6px; font-weight: 600; font-size: 12px;">
                                    Day ${session.day}
                                </div>
                            </div>
                        `;
                    }).join('');
            }
        }

        function renderDay() {
            const data = workoutData[currentDay];
            document.getElementById('dayInfo').innerHTML = `
                <div class="day-title">${data.title}</div>
                <div class="day-description">${data.description}</div>
            `;
            
            document.getElementById('mobilityContent').textContent = data.mobility;

            const exercisesList = document.getElementById('exercisesList');
            exercisesList.innerHTML = data.exercises.map((ex, idx) => {
                const isLogged = isExerciseLoggedToday(currentDay, ex.name);
                const stats = getExerciseStats(currentDay, ex.name);
                const isPR = stats.isPR;
                
                return `
                    <div class="exercise-card ${isLogged ? 'logged' : ''}" onclick="openExercise(${idx})">
                        ${isPR ? '<div class="pr-badge">PR!</div>' : ''}
                        <div class="exercise-header">
                            <div class="exercise-number">${idx + 1}</div>
                            <div class="exercise-info">
                                <div class="exercise-name">${ex.name}</div>
                                <div class="exercise-details">
                                    ${ex.note ? ex.note + ' √ó ' : ''}${ex.sets} √ó ${ex.reps}
                                </div>
                                ${stats.lastWeight ? `
                                    <div class="exercise-stats">
                                        <div class="stat-item">
                                            <strong>${stats.lastWeight}kg</strong> last session
                                        </div>
                                        ${stats.trend ? `
                                            <div class="stat-item">
                                                Trend: <span class="stat-trend ${stats.trend > 0 ? 'up' : 'down'}">
                                                    ${stats.trend > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(stats.trend)}%
                                                </span>
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            updateProgress();
        }

        function getExerciseStats(day, exerciseName) {
            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const logs = history.filter(w => w.day === day && w.exercise === exerciseName);
            
            if (logs.length === 0) return {};
            
            const last = logs[logs.length - 1];
            const lastWeight = Math.max(...last.sets.map(s => s.weight));
            
            const all1RMs = logs.map(log => {
                const heaviestSet = log.sets.reduce((max, set) => 
                    set.weight > max.weight ? set : max
                );
                return calculate1RM(heaviestSet.weight, heaviestSet.reps);
            });
            const current1RM = all1RMs[all1RMs.length - 1];
            const isPR = current1RM === Math.max(...all1RMs);
            
            let trend = null;
            if (logs.length >= 2) {
                const previous = logs[logs.length - 2];
                const prevWeight = Math.max(...previous.sets.map(s => s.weight));
                trend = Math.round(((lastWeight - prevWeight) / prevWeight) * 100);
            }
            
            return { lastWeight, trend, isPR };
        }

        function isExerciseLoggedToday(day, exerciseName) {
            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const today = new Date().toDateString();
            return history.some(w => 
                w.day === day && 
                w.exercise === exerciseName && 
                new Date(w.date).toDateString() === today
            );
        }

        function updateProgress() {
            const totalExercises = workoutData[currentDay].exercises.length;
            const completed = countCompletedExercises();
            const percentage = (completed / totalExercises) * 100;
            
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = 
                `${completed} / ${totalExercises} exercises completed`;
        }

        function countCompletedExercises() {
            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const today = new Date().toDateString();
            const todayWorkouts = history.filter(w => 
                w.day === currentDay && 
                new Date(w.date).toDateString() === today
            );
            return new Set(todayWorkouts.map(w => w.exercise)).size;
        }

        function toggleWorkout() {
            workoutActive = !workoutActive;
            const btn = document.getElementById('startWorkoutBtn');
            const timer = document.getElementById('sessionTimer');
            const progress = document.getElementById('workoutProgress');

            if (workoutActive) {
                btn.textContent = 'End Workout';
                btn.classList.add('active');
                timer.classList.add('active');
                progress.style.display = 'block';
                sessionStartTime = Date.now();
                sessionInterval = setInterval(updateSessionTimer, 1000);
                startAutoSave();
                saveSessionState();
                showToast('Workout started! Let\'s go! üèâ', 'success');
            } else {
                if (confirm('Are you sure you want to end this workout?')) {
                    showSummary();
                } else {
                    workoutActive = true;
                }
            }
        }

        function updateSessionTimer() {
            if (!sessionStartTime) return;
            const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('sessionTimer').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // ============================================
        // EXERCISE MODAL FUNCTIONS
        // ============================================
        function openExercise(idx) {
            currentExercise = workoutData[currentDay].exercises[idx];
            currentExerciseIndex = idx;
            currentSetCount = currentExercise.sets;
            
            document.getElementById('modalExerciseName').textContent = currentExercise.name;
            document.getElementById('modalExerciseTarget').textContent = 
                `Target: ${currentExercise.sets} √ó ${currentExercise.reps}`;
            
            const viewOnly = !workoutActive && !currentEditWorkoutId;
            document.getElementById('viewOnlyNotice').style.display = viewOnly ? 'block' : 'none';
            document.getElementById('restTimer').style.display = viewOnly ? 'none' : 'block';
            document.getElementById('addSetBtn').style.display = viewOnly ? 'none' : 'block';
            document.getElementById('actionButtons').style.display = viewOnly ? 'none' : 'grid';
            document.getElementById('exerciseNotes').disabled = viewOnly;
            
            const lastWorkout = getLastWorkoutData(currentDay, currentExercise.name);
            if (lastWorkout && !viewOnly && !currentEditWorkoutId) {
                document.getElementById('prefillSection').style.display = 'block';
                document.getElementById('prefillData').textContent = 
                    lastWorkout.sets.map(s => `${s.weight}kg √ó ${s.reps}`).join(', ');
            } else {
                document.getElementById('prefillSection').style.display = 'none';
            }

            renderSets(viewOnly);
            loadExerciseHistory();
            calculateStatsWithComparison();
            document.getElementById('exerciseModal').classList.add('active');
            
            history.pushState({ page: 'modal', type: 'exercise', timestamp: Date.now() }, '', '');
            historyStack.push('modal');

            if (workoutActive) {
                document.querySelectorAll('.exercise-card').forEach(card => {
                    card.classList.remove('in-progress');
                });
                document.querySelectorAll('.exercise-card')[idx].classList.add('in-progress');
            }
        }

        function closeModal() {
            document.getElementById('exerciseModal').classList.remove('active');
            stopRestTimer();
            restTimerSeconds = 90;
            updateRestTimerDisplay();
            
            currentEditWorkoutId = null;
            const saveBtn = document.querySelector('.save-btn');
            if (saveBtn) saveBtn.textContent = 'Save';
            
            const sessionDetail = document.getElementById('sessionDetailContent');
            if (sessionDetail) {
                sessionDetail.remove();
            }
            
            document.getElementById('restTimer').style.display = 'block';
            const historySection = document.querySelector('.history-section');
            if (historySection) historySection.style.display = 'block';
            document.getElementById('setsContainer').style.display = 'block';
            document.getElementById('addSetBtn').style.display = 'block';
            document.querySelector('.stats-grid').style.display = 'grid';
            document.querySelector('.notes-section').style.display = 'block';
            document.getElementById('actionButtons').style.display = 'grid';
            const sectionTitles = document.getElementById('setsContainer').parentElement.querySelectorAll('.section-title');
            if (sectionTitles[0]) sectionTitles[0].style.display = 'block';
            
            historyStack.back();
            history.back();
        }

        function getLastWorkoutData(day, exerciseName) {
            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const logs = history.filter(w => w.day === day && w.exercise === exerciseName);
            return logs.length > 0 ? logs[logs.length - 1] : null;
        }

        function renderSets(disabled = false) {
            const container = document.getElementById('setsContainer');
            container.innerHTML = '';
            
            for (let i = 1; i <= currentSetCount; i++) {
                container.innerHTML += `
                    <div class="set-row" id="set-row-${i}">
                        <div class="set-label">Set ${i}</div>
                        <div class="input-group">
                            <input type="number" step="0.5" class="input-field" placeholder="0" 
                                   ${disabled ? 'disabled' : ''} onchange="calculateStatsWithComparison(); autoStartRestTimer()" 
                                   data-set="${i}" data-type="weight" id="weight-${i}">
                            <div class="input-label">Weight (kg)</div>
                        </div>
                        <div class="input-group">
                            <input type="number" class="input-field" placeholder="0" 
                                   ${disabled ? 'disabled' : ''} onchange="calculateStatsWithComparison(); autoStartRestTimer()" 
                                   data-set="${i}" data-type="reps" id="reps-${i}">
                            <div class="input-label">Reps</div>
                        </div>
                        ${i > 1 && !disabled ? '<button class="remove-set" onclick="removeSet(' + i + ')">√ó</button>' : '<div></div>'}
                    </div>
                `;
            }
        }

        function addSet() {
            const existingValues = [];
            for (let i = 1; i <= currentSetCount; i++) {
                const weight = document.querySelector(`[data-set="${i}"][data-type="weight"]`)?.value;
                const reps = document.querySelector(`[data-set="${i}"][data-type="reps"]`)?.value;
                existingValues.push({ 
                    weight: weight || '', 
                    reps: reps || '' 
                });
            }
            
            currentSetCount++;
            renderSets(false);
            
            setTimeout(() => {
                existingValues.forEach((set, idx) => {
                    const weightInput = document.querySelector(`[data-set="${idx + 1}"][data-type="weight"]`);
                    const repsInput = document.querySelector(`[data-set="${idx + 1}"][data-type="reps"]`);
                    if (weightInput && set.weight) weightInput.value = set.weight;
                    if (repsInput && set.reps) repsInput.value = set.reps;
                });
                calculateStatsWithComparison();
            }, 10);
        }

        function removeSet(setNum) {
            const existingValues = [];
            for (let i = 1; i <= currentSetCount; i++) {
                if (i === setNum) continue;
                
                const weight = document.querySelector(`[data-set="${i}"][data-type="weight"]`)?.value;
                const reps = document.querySelector(`[data-set="${i}"][data-type="reps"]`)?.value;
                existingValues.push({ 
                    weight: weight || '', 
                    reps: reps || '' 
                });
            }
            
            currentSetCount--;
            renderSets(false);
            
            setTimeout(() => {
                existingValues.forEach((set, idx) => {
                    const weightInput = document.querySelector(`[data-set="${idx + 1}"][data-type="weight"]`);
                    const repsInput = document.querySelector(`[data-set="${idx + 1}"][data-type="reps"]`);
                    if (weightInput && set.weight) weightInput.value = set.weight;
                    if (repsInput && set.reps) repsInput.value = set.reps;
                });
                calculateStatsWithComparison();
            }, 10);
        }

        function prefillLastWorkout() {
            const lastWorkout = getLastWorkoutData(currentDay, currentExercise.name);
            if (!lastWorkout) return;

            lastWorkout.sets.forEach((set, idx) => {
                const weightInput = document.querySelector(`[data-set="${idx + 1}"][data-type="weight"]`);
                const repsInput = document.querySelector(`[data-set="${idx + 1}"][data-type="reps"]`);
                if (weightInput) weightInput.value = set.weight;
                if (repsInput) repsInput.value = set.reps;
            });

            calculateStatsWithComparison();
            showToast('Last workout loaded!', 'info');
        }

        function autoStartRestTimer() {
            if (!restTimerActive && workoutActive) {
                setTimeout(() => {
                    startRestTimer();
                }, 500);
            }
        }

        function setRestTimer(seconds) {
            restTimerSeconds = seconds;
            updateRestTimerDisplay();
        }

        function toggleRestTimer() {
            if (restTimerActive) {
                stopRestTimer();
            } else {
                startRestTimer();
            }
        }

        function startRestTimer() {
            if (restTimerActive) return;
            
            restTimerActive = true;
            document.getElementById('restTimer').classList.add('active');
            document.getElementById('restTimerBtn').textContent = 'Stop';
            document.getElementById('restTimerBtn').classList.add('active');
            
            restTimerInterval = setInterval(() => {
                restTimerSeconds--;
                updateRestTimerDisplay();
                
                if (restTimerSeconds <= 0) {
                    stopRestTimer();
                    playAlert();
                    restTimerSeconds = 90;
                    updateRestTimerDisplay();
                }
            }, 1000);
        }

        function stopRestTimer() {
            restTimerActive = false;
            clearInterval(restTimerInterval);
            document.getElementById('restTimer').classList.remove('active');
            document.getElementById('restTimerBtn').textContent = 'Start';
            document.getElementById('restTimerBtn').classList.remove('active');
        }

        function updateRestTimerDisplay() {
            const minutes = Math.floor(restTimerSeconds / 60);
            const seconds = restTimerSeconds % 60;
            document.getElementById('restTimerDisplay').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function startMobilityTimer() {
            if (mobilityTimerActive) return;
            
            mobilityTimerActive = true;
            document.getElementById('mobilityTimer').classList.add('active');
            
            mobilityTimerInterval = setInterval(() => {
                mobilityTimerSeconds--;
                updateMobilityTimerDisplay();
                
                if (mobilityTimerSeconds <= 0) {
                    resetMobilityTimer();
                    playAlert();
                }
            }, 1000);
        }

        function resetMobilityTimer() {
            mobilityTimerActive = false;
            clearInterval(mobilityTimerInterval);
            document.getElementById('mobilityTimer').classList.remove('active');
            mobilityTimerSeconds = 45;
            updateMobilityTimerDisplay();
        }

        function updateMobilityTimerDisplay() {
            const minutes = Math.floor(mobilityTimerSeconds / 60);
            const seconds = mobilityTimerSeconds % 60;
            document.getElementById('mobilityTimerDisplay').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function playAlert() {
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
        }

        function calculateStatsWithComparison() {
            if (!currentExercise || !currentExercise.name) {
                return;
            }
            
            const inputs = document.querySelectorAll('.input-field');
            let maxWeight = 0;
            let maxReps = 0;
            let totalVolume = 0;

            inputs.forEach(input => {
                const set = input.dataset.set;
                const type = input.dataset.type;
                const value = parseFloat(input.value) || 0;

                if (type === 'weight' && value > maxWeight) {
                    maxWeight = value;
                    const repsInput = document.querySelector(`[data-set="${set}"][data-type="reps"]`);
                    maxReps = parseFloat(repsInput.value) || 0;
                }

                if (type === 'weight') {
                    const repsInput = document.querySelector(`[data-set="${set}"][data-type="reps"]`);
                    const reps = parseFloat(repsInput.value) || 0;
                    totalVolume += value * reps;
                }
            });

            const estimated1RM = calculate1RM(maxWeight, maxReps);
            
            const lastWorkout = getLastWorkoutData(currentDay, currentExercise.name);
            if (lastWorkout) {
                const lastMax = lastWorkout.sets.reduce((max, set) => 
                    set.weight > max.weight ? set : max
                );
                const last1RM = calculate1RM(lastMax.weight, lastMax.reps);
                const lastVolume = lastWorkout.sets.reduce((sum, set) => sum + (set.weight * set.reps), 0);
                
                if (estimated1RM > 0) {
                    const rmDiff = estimated1RM - last1RM;
                    document.getElementById('comparison1RM').textContent = 
                        rmDiff > 0 ? `‚Üë ${rmDiff}kg from last` : rmDiff < 0 ? `‚Üì ${Math.abs(rmDiff)}kg from last` : 'Same as last';
                    document.getElementById('comparison1RM').className = 
                        rmDiff > 0 ? 'stat-comparison up' : rmDiff < 0 ? 'stat-comparison down' : 'stat-comparison';
                    
                    if (rmDiff > 0) {
                        document.getElementById('card1RM').classList.add('pr');
                    } else {
                        document.getElementById('card1RM').classList.remove('pr');
                    }
                }
                
                if (totalVolume > 0) {
                    const volDiff = totalVolume - lastVolume;
                    document.getElementById('comparisonVolume').textContent = 
                        volDiff > 0 ? `‚Üë ${Math.round(volDiff)}kg from last` : volDiff < 0 ? `‚Üì ${Math.abs(Math.round(volDiff))}kg from last` : 'Same as last';
                    document.getElementById('comparisonVolume').className = 
                        volDiff > 0 ? 'stat-comparison up' : volDiff < 0 ? 'stat-comparison down' : 'stat-comparison';
                }
            }
            
            document.getElementById('estimated1RM').textContent = estimated1RM > 0 ? estimated1RM + ' kg' : '‚Äî';
            document.getElementById('totalVolume').textContent = totalVolume > 0 ? Math.round(totalVolume) + ' kg' : '‚Äî';
        }

        function saveWorkout() {
            const inputs = document.querySelectorAll('.input-field');
            const sets = [];

            for (let i = 1; i <= currentSetCount; i++) {
                const weight = document.querySelector(`[data-set="${i}"][data-type="weight"]`)?.value;
                const reps = document.querySelector(`[data-set="${i}"][data-type="reps"]`)?.value;
                if (weight && reps) {
                    sets.push({ weight: parseFloat(weight), reps: parseInt(reps) });
                }
            }

            if (sets.length === 0) {
                showToast('Please enter at least one set!', 'error');
                return;
            }

            try {
                validateWorkoutInputs(sets);
            } catch (error) {
                showToast(error.message, 'error');
                return;
            }

            let duration = null;
            if (currentEditWorkoutId) {
                const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
                const existing = history.find(w => w.id === currentEditWorkoutId);
                if (existing) duration = existing.duration;
            } else if (sessionStartTime) {
                duration = Math.floor((Date.now() - sessionStartTime) / 60000);
            }

            const workout = {
                id: currentEditWorkoutId || Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9),
                day: currentDay,
                exercise: currentExercise.name,
                date: new Date().toISOString(),
                sets: sets,
                notes: document.getElementById('exerciseNotes').value,
                duration: duration
            };

            let history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            
            if (currentEditWorkoutId) {
                const index = history.findIndex(w => w.id === currentEditWorkoutId);
                if (index !== -1) {
                    history[index] = workout;
                }
                currentEditWorkoutId = null;
                showToast('Workout updated! ‚úÖ', 'success');
            } else {
                history.push(workout);
                showToast('Exercise saved! üí™', 'success');
            }
            
            localStorage.setItem('workoutHistory', JSON.stringify(history));

            document.getElementById('exerciseNotes').value = '';
            stopRestTimer();
            restTimerSeconds = 90;

            closeModal();
            renderDay();
            
            if (document.getElementById('statsTab').style.display !== 'none') {
                renderStats();
            }
        }

        function saveAndNext() {
            saveWorkout();
            
            const nextIndex = currentExerciseIndex + 1;
            if (nextIndex < workoutData[currentDay].exercises.length) {
                setTimeout(() => openExercise(nextIndex), 300);
            } else {
                showToast('All exercises complete! Great work! üéâ', 'success');
            }
        }

        function loadExerciseHistory() {
            if (!currentExercise || !currentExercise.name) {
                const container = document.getElementById('historyContainer');
                container.innerHTML = '<div style="color: #999; font-style: italic;">No previous workouts recorded</div>';
                return;
            }
            
            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const exerciseHistory = history
                .filter(w => w.exercise === currentExercise.name && w.day === currentDay)
                .slice(-5)
                .reverse();

            const container = document.getElementById('historyContainer');
            
            if (exerciseHistory.length === 0) {
                container.innerHTML = '<div style="color: #999; font-style: italic;">No previous workouts recorded</div>';
                return;
            }

            container.innerHTML = exerciseHistory.map(workout => {
                const date = new Date(workout.date).toLocaleDateString();
                const setsText = workout.sets.map(s => `${s.weight}kg √ó ${s.reps}`).join(', ');
                const max1RM = Math.max(...workout.sets.map(s => calculate1RM(s.weight, s.reps)));
                
                const allWorkouts = history.filter(w => w.exercise === currentExercise.name && w.day === currentDay);
                const all1RMs = allWorkouts.map(w => Math.max(...w.sets.map(s => calculate1RM(s.weight, s.reps))));
                const isPR = max1RM === Math.max(...all1RMs);
                
                return `
                    <div class="history-item ${isPR ? 'pr-session' : ''}">
                        <div class="history-actions">
                            <button class="edit-history-btn" onclick="editWorkout('${workout.id}', event)">‚úé</button>
                            <button class="delete-history-btn" onclick="deleteWorkoutEntry('${workout.id}', event)">√ó</button>
                        </div>
                        <div class="history-date">${date} ${isPR ? '<span class="pr-badge-inline">PR</span>' : ''}</div>
                        <div class="history-sets">${setsText}</div>
                        <div style="margin-top: 6px; font-size: 12px; color: #888;">Est. 1RM: ${max1RM}kg</div>
                        ${workout.notes ? `<div style="margin-top: 6px; font-style: italic; font-size: 13px;">"${workout.notes}"</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function editWorkout(workoutId, event) {
            if (event) event.stopPropagation();
            
            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const workout = history.find(w => w.id === workoutId);
            
            if (!workout) {
                showToast('Workout not found!', 'error');
                return;
            }
            
            currentEditWorkoutId = workoutId;
            currentDay = workout.day;
            
            const exercises = workoutData[workout.day].exercises;
            const exerciseIndex = exercises.findIndex(ex => ex.name === workout.exercise);
            
            if (exerciseIndex === -1) {
                currentExercise = {
                    name: workout.exercise,
                    sets: workout.sets.length,
                    reps: '0'
                };
                currentExerciseIndex = -1;
            } else {
                currentExercise = exercises[exerciseIndex];
                currentExerciseIndex = exerciseIndex;
            }
            
            currentSetCount = workout.sets.length;
            
            document.getElementById('modalExerciseName').textContent = workout.exercise;
            document.getElementById('modalExerciseTarget').textContent = 
                `Editing ${workout.sets.length} sets from ${new Date(workout.date).toLocaleDateString()}`;
            
            document.getElementById('viewOnlyNotice').style.display = 'none';
            document.getElementById('restTimer').style.display = 'none';
            document.getElementById('addSetBtn').style.display = 'block';
            document.getElementById('actionButtons').style.display = 'grid';
            document.getElementById('exerciseNotes').disabled = false;
            document.getElementById('prefillSection').style.display = 'none';
            
            const sectionTitles = document.querySelectorAll('.section-title');
            sectionTitles.forEach(title => title.style.display = 'block');
            document.getElementById('setsContainer').style.display = 'block';
            document.getElementById('setsContainer').parentElement.style.display = 'block';
            
            renderSets(false);
            
            workout.sets.forEach((set, i) => {
                const weightInput = document.querySelector(`[data-set="${i + 1}"][data-type="weight"]`);
                const repsInput = document.querySelector(`[data-set="${i + 1}"][data-type="reps"]`);
                if (weightInput) weightInput.value = set.weight;
                if (repsInput) repsInput.value = set.reps;
            });
            
            document.getElementById('exerciseNotes').value = workout.notes || '';
            
            document.getElementById('actionButtons').innerHTML = `
                <button class="save-btn" onclick="updateWorkout('${workoutId}')">Update</button>
                <button class="next-btn" style="background: var(--red);" onclick="deleteAndClose('${workoutId}')">Delete</button>
            `;
            
            loadExerciseHistory();
            calculateStatsWithComparison();
            document.getElementById('exerciseModal').classList.add('active');
            history.pushState({ page: 'modal', type: 'editExercise', timestamp: Date.now() }, '', '');
            historyStack.push('modal');
        }

        function updateWorkout(workoutId) {
            const sets = [];
            for (let i = 1; i <= currentSetCount; i++) {
                const weight = parseFloat(document.querySelector(`[data-set="${i}"][data-type="weight"]`)?.value);
                const reps = parseInt(document.querySelector(`[data-set="${i}"][data-type="reps"]`)?.value);
                
                if (weight && reps) {
                    sets.push({ weight, reps });
                }
            }
            
            if (sets.length === 0) {
                showToast('Please enter at least one set!', 'error');
                return;
            }
            
            try {
                validateWorkoutInputs(sets);
            } catch (error) {
                showToast(error.message, 'error');
                return;
            }
            
            const notes = document.getElementById('exerciseNotes').value;
            
            let history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const workoutIndex = history.findIndex(w => w.id === workoutId);
            
            if (workoutIndex === -1) {
                showToast('Error: Workout not found!', 'error');
                return;
            }
            
            history[workoutIndex].sets = sets;
            history[workoutIndex].notes = notes;
            
            localStorage.setItem('workoutHistory', JSON.stringify(history));
            
            showToast('‚úÖ Workout updated!', 'success');
            closeModal();
            renderHistory();
            renderDay();
        }

        function deleteAndClose(workoutId) {
            if (confirm('Delete this workout?')) {
                deleteLogEntry(workoutId);
                closeModal();
            }
        }

        function deleteWorkoutEntry(workoutId, event) {
            if (event) event.stopPropagation();
            
            if (!confirm('Delete this workout?')) return;
            
            let history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const deletedWorkout = history.find(w => w.id === workoutId);
            
            if (deletedWorkout) {
                showUndo(deletedWorkout);
                
                history = history.filter(w => w.id !== workoutId);
                localStorage.setItem('workoutHistory', JSON.stringify(history));
                
                showToast('Workout deleted', 'info');
                
                loadExerciseHistory();
                renderDay();
                
                if (document.getElementById('statsTab').style.display !== 'none') {
                    renderStats();
                }
            }
        }

        function deleteLogEntry(workoutId) {
            if (!confirm('Delete this workout log?')) return;
            
            let history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const deletedWorkout = history.find(w => w.id === workoutId);
            
            if (deletedWorkout) {
                showUndo(deletedWorkout);
                
                history = history.filter(w => w.id !== workoutId);
                localStorage.setItem('workoutHistory', JSON.stringify(history));
                
                showToast('Workout deleted', 'info');
                
                renderHistory();
                renderDay();
                
                if (document.getElementById('statsTab').style.display !== 'none') {
                    renderStats();
                }
            }
        }

        function showSummary() {
            const duration = Math.floor((Date.now() - sessionStartTime) / 1000);
            const minutes = Math.floor(duration / 60);
            
            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const today = new Date().toDateString();
            const todayWorkouts = history.filter(w => 
                w.day === currentDay && 
                new Date(w.date).toDateString() === today
            );
            
            const totalSets = todayWorkouts.reduce((sum, w) => sum + w.sets.length, 0);
            const totalVolume = todayWorkouts.reduce((sum, w) => 
                sum + w.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
            );
            const uniqueExercises = new Set(todayWorkouts.map(w => w.exercise)).size;

            document.getElementById('summaryDuration').textContent = minutes + 'm';
            document.getElementById('summaryExercises').textContent = uniqueExercises;
            document.getElementById('summaryVolume').textContent = Math.round(totalVolume) + 'kg';
            document.getElementById('summarySets').textContent = totalSets;

            document.getElementById('summaryModal').classList.add('active');
            
            history.pushState({ page: 'summary', timestamp: Date.now() }, '', '');
            historyStack.push('summary');
        }

        function closeSummary() {
            document.getElementById('summaryModal').classList.remove('active');
            historyStack.back();
            history.back();
        }

        function finishWorkout() {
            workoutActive = false;
            clearInterval(sessionInterval);
            sessionStartTime = null;
            
            const btn = document.getElementById('startWorkoutBtn');
            const timer = document.getElementById('sessionTimer');
            const progress = document.getElementById('workoutProgress');
            
            btn.textContent = 'Start Workout';
            btn.classList.remove('active');
            timer.classList.remove('active');
            timer.textContent = '00:00';
            progress.style.display = 'none';
            
            clearSessionState();
            closeSummary();
            renderDay();
            showToast('Great session! See you next time! üèâ', 'success');
        }

        // ============================================
        // HISTORY FUNCTIONS
        // ============================================
        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            
            const thisWeek = getThisWeekWorkouts(history);
            const lastWeek = getLastWeekWorkouts(history);
            const allPRs = countPRs(history);
            
            const thisWeekCount = new Set(thisWeek.map(w => new Date(w.date).toDateString())).size;
            const lastWeekCount = new Set(lastWeek.map(w => new Date(w.date).toDateString())).size;
            
            const strengthScore = calculateCoreStrengthScore(history);
            const lastWeekScore = calculateCoreStrengthScore(lastWeek);
            const scoreChange = strengthScore - lastWeekScore;
            
            const uniqueExercises = new Set(history.map(w => w.exercise)).size;
            const accessoryData = calculateAccessoryScore(history);
            
            document.getElementById('historyWeeklyWorkouts').textContent = thisWeekCount;
            document.getElementById('historyTotalPRs').textContent = allPRs;
            document.getElementById('historyBestLifts').textContent = uniqueExercises;
            document.getElementById('historyAccessoryCount').textContent = accessoryData.count;
            
            renderExerciseLog(history);
        }

        function renderExerciseLog(history) {
            const filtered = filterHistory(history, currentLogFilter);
            const container = document.getElementById('exerciseLogContent');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="no-history">No workouts recorded yet. Start training!</div>';
                return;
            }
            
            const sessions = {};
            filtered.forEach(workout => {
                const dateKey = new Date(workout.date).toDateString();
                const sessionKey = `${dateKey}-${workout.day}`;
                
                if (!sessions[sessionKey]) {
                    sessions[sessionKey] = {
                        date: workout.date,
                        day: workout.day,
                        exercises: []
                    };
                }
                
                sessions[sessionKey].exercises.push(workout);
            });
            
            const sortedSessions = Object.values(sessions).sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            container.innerHTML = sortedSessions.map((session, idx) => {
                const date = new Date(session.date).toLocaleDateString('en-US', {
                    weekday: 'long',
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                
                const totalVolume = session.exercises.reduce((sum, ex) => 
                    sum + ex.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                );
                const totalSets = session.exercises.reduce((sum, ex) => sum + ex.sets.length, 0);
                const duration = session.exercises[0].duration;
                
                const hasPR = session.exercises.some(workout => {
                    const allWorkouts = history.filter(w => w.exercise === workout.exercise && w.day === workout.day);
                    const all1RMs = allWorkouts.map(w => Math.max(...w.sets.map(s => calculate1RM(s.weight, s.reps))));
                    const current1RM = Math.max(...workout.sets.map(s => calculate1RM(s.weight, s.reps)));
                    return current1RM === Math.max(...all1RMs);
                });
                
                return `
                    <div class="log-entry ${hasPR ? 'pr-entry' : ''}" data-session-index="${idx}" style="cursor: pointer;">
                        <div class="log-entry-header">
                            <div class="log-entry-name">
                                ${date}
                                ${hasPR ? '<span class="pr-badge-inline">PR</span>' : ''}
                            </div>
                            <div class="log-entry-date">Day ${session.day}</div>
                        </div>
                        <div style="margin: 12px 0; font-size: 14px; color: var(--light-blue);">
                            ${session.exercises.map(ex => ex.exercise).join(' ‚Ä¢ ')}
                        </div>
                        <div class="log-entry-stats">
                            <span>üí™ ${session.exercises.length} exercises</span>
                            <span>üìä ${totalSets} sets</span>
                            <span>üèãÔ∏è ${Math.round(totalVolume)}kg volume</span>
                            ${duration ? `<span>‚è±Ô∏è ${duration}m</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.querySelectorAll('.log-entry').forEach((entry, idx) => {
                entry.addEventListener('click', function(e) {
                    if (e.target.tagName === 'BUTTON') return;
                    
                    const sessionIndex = parseInt(this.dataset.sessionIndex);
                    const allHistory = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
                    openSessionDetail(sortedSessions[sessionIndex], allHistory);
                });
            });
        }

        function openSessionDetail(session, allHistory) {
            const date = new Date(session.date).toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
            
            const totalVolume = session.exercises.reduce((sum, ex) => 
                sum + ex.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
            );
            const totalSets = session.exercises.reduce((sum, ex) => sum + ex.sets.length, 0);
            const duration = session.exercises[0].duration;
            const durationDisplay = duration ? `${duration}m` : '‚Äî';
            
            document.getElementById('modalExerciseName').textContent = date;
            document.getElementById('modalExerciseTarget').textContent = `Day ${session.day} - Complete Session`;
            
            document.getElementById('viewOnlyNotice').style.display = 'none';
            document.getElementById('restTimer').style.display = 'none';
            document.getElementById('prefillSection').style.display = 'none';
            const sectionTitles = document.getElementById('setsContainer').parentElement.querySelectorAll('.section-title');
            if (sectionTitles[0]) sectionTitles[0].style.display = 'none';
            document.getElementById('setsContainer').style.display = 'none';
            document.getElementById('addSetBtn').style.display = 'none';
            document.querySelector('.stats-grid').style.display = 'none';
            document.querySelector('.notes-section').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'none';
            
            const sessionDetailHTML = `
                <div style="background: var(--pale-yellow); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div style="text-align: center;">
                            <div style="font-family: 'Bebas Neue', sans-serif; font-size: 32px; color: var(--niue-blue);">${session.exercises.length}</div>
                            <div style="font-size: 12px; color: var(--light-blue); font-weight: 600;">EXERCISES</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-family: 'Bebas Neue', sans-serif; font-size: 32px; color: var(--niue-blue);">${totalSets}</div>
                            <div style="font-size: 12px; color: var(--light-blue); font-weight: 600;">TOTAL SETS</div>
                        </div>
                        <div style="text-align: center; grid-column: 1 / -1;">
                            <div style="font-family: 'Bebas Neue', sans-serif; font-size: 32px; color: var(--niue-blue);">${Math.round(totalVolume)}</div>
                            <div style="font-size: 12px; color: var(--light-blue); font-weight: 600;">TOTAL VOLUME (KG)</div>
                        </div>
                        <div style="text-align: center; grid-column: 1 / -1;">
                            <div style="font-family: 'Bebas Neue', sans-serif; font-size: 32px; color: var(--niue-blue);">${durationDisplay}</div>
                            <div style="font-size: 12px; color: var(--light-blue); font-weight: 600;">DURATION</div>
                        </div>
                    </div>
                </div>

                <div class="section-title">Exercises</div>
                <div id="sessionExercisesList">
                ${session.exercises.map(ex => {
                    const max1RM = Math.max(...ex.sets.map(s => calculate1RM(s.weight, s.reps)));
                    const exVolume = ex.sets.reduce((sum, set) => sum + (set.weight * set.reps), 0);
                    
                    const allWorkouts = allHistory.filter(w => w.exercise === ex.exercise && w.day === ex.day);
                    const all1RMs = allWorkouts.map(w => Math.max(...w.sets.map(s => calculate1RM(s.weight, s.reps))));
                    const isPR = max1RM === Math.max(...all1RMs);
                    
                    const prevWorkouts = allWorkouts.filter(w => new Date(w.date) < new Date(ex.date));
                    let comparison = '';
                    if (prevWorkouts.length > 0) {
                        const lastWorkout = prevWorkouts[prevWorkouts.length - 1];
                        const lastMax = Math.max(...lastWorkout.sets.map(s => s.weight));
                        const currentMax = Math.max(...ex.sets.map(s => s.weight));
                        const diff = currentMax - lastMax;
                        if (diff > 0) comparison = `<span style="color: var(--green);">‚Üë ${diff}kg from previous</span>`;
                        else if (diff < 0) comparison = `<span style="color: var(--red);">‚Üì ${Math.abs(diff)}kg from previous</span>`;
                        else comparison = `<span style="color: #888;">Same as previous</span>`;
                    }
                    
                    return `
                        <div style="background: white; padding: 16px; border-radius: 10px; margin-bottom: 12px; border-left: 4px solid ${isPR ? '#ffd700' : 'var(--niue-yellow)'}; position: relative;">
                            <div style="position: absolute; top: 12px; right: 12px; display: flex; gap: 8px;">
                                <button class="edit-session-exercise" data-edit-id="${ex.id}" style="background: #e3f2fd; border: none; color: #1976d2; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;">‚úé</button>
                                <button class="delete-session-exercise" data-delete-id="${ex.id}" style="background: #fee; border: none; color: #c44; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; font-size: 16px;">√ó</button>
                            </div>
                            <div style="font-weight: 700; color: var(--niue-blue); font-size: 18px; margin-bottom: 8px; padding-right: 80px;">
                                ${ex.exercise}
                                ${isPR ? '<span class="pr-badge-inline">PR</span>' : ''}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; margin-bottom: 8px;">
                                ${ex.sets.map((s, i) => `
                                    <div style="background: var(--pale-yellow); padding: 8px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 11px; color: #888; font-weight: 600;">SET ${i + 1}</div>
                                        <div style="font-weight: 700; color: var(--niue-blue);">${s.weight}kg</div>
                                        <div style="font-size: 13px; color: var(--light-blue);">√ó ${s.reps}</div>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="display: flex; gap: 16px; font-size: 13px; color: #666; margin-top: 12px;">
                                <span>üí™ Volume: <strong>${Math.round(exVolume)}kg</strong></span>
                                <span>üìä Est. 1RM: <strong>${max1RM}kg</strong></span>
                            </div>
                            ${comparison ? `<div style="font-size: 13px; margin-top: 8px;">${comparison}</div>` : ''}
                            ${ex.notes ? `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee; font-size: 14px; font-style: italic; color: #666;">"${ex.notes}"</div>` : ''}
                        </div>
                    `;
                }).join('')}
                </div>

                <button id="deleteEntireSession" style="width: 100%; padding: 16px; background: var(--red); color: white; border: none; border-radius: 10px; font-family: 'Bebas Neue', sans-serif; font-size: 18px; cursor: pointer; margin-top: 24px;">
                    üóëÔ∏è Delete Entire Session
                </button>
            `;
            
            const historySection = document.querySelector('.history-section');
            historySection.style.display = 'none';
            
            historySection.insertAdjacentHTML('beforebegin', `<div id="sessionDetailContent">${sessionDetailHTML}</div>`);
            
            document.querySelectorAll('.edit-session-exercise').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const workoutId = this.dataset.editId;
                    closeModal();
                    setTimeout(() => editWorkout(workoutId), 100);
                });
            });
            
            document.querySelectorAll('.delete-session-exercise').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const workoutId = this.dataset.deleteId;
                    if (confirm('Delete this exercise from the session?')) {
                        deleteLogEntry(workoutId);
                        closeModal();
                    }
                });
            });
            
            const deleteSessionBtn = document.getElementById('deleteEntireSession');
            if (deleteSessionBtn) {
                deleteSessionBtn.addEventListener('click', function() {
                    if (confirm(`‚ö†Ô∏è Delete entire session?\n\nThis will remove all ${session.exercises.length} exercises from ${date}.\n\nThis cannot be undone!`)) {
                        let history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
                        const exerciseIds = session.exercises.map(ex => ex.id);
                        history = history.filter(w => !exerciseIds.includes(w.id));
                        localStorage.setItem('workoutHistory', JSON.stringify(history));
                        
                        showToast('‚úÖ Session deleted!', 'success');
                        closeModal();
                        renderHistory();
                        renderDay();
                    }
                });
            }
            
            document.getElementById('exerciseModal').classList.add('active');
            
            history.pushState({ page: 'session-detail', timestamp: Date.now() }, '', '');
            historyStack.push('session-detail');
        }

        function filterLog(filter) {
            currentLogFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            renderExerciseLog(history);
        }

        function filterHistory(history, filter) {
            if (filter === 'all') return history;
            if (filter === 'dayA') return history.filter(w => w.day === 'A');
            if (filter === 'dayB') return history.filter(w => w.day === 'B');
            if (filter === 'dayC') return history.filter(w => w.day === 'C');
            return history;
        }

        function getThisWeekWorkouts(history) {
            const now = new Date();
            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
            weekStart.setHours(0, 0, 0, 0);
            
            return history.filter(w => new Date(w.date) >= weekStart);
        }

        function getLastWeekWorkouts(history) {
            const now = new Date();
            const thisWeekStart = new Date(now.setDate(now.getDate() - now.getDay()));
            thisWeekStart.setHours(0, 0, 0, 0);
            
            const lastWeekStart = new Date(thisWeekStart);
            lastWeekStart.setDate(lastWeekStart.getDate() - 7);
            
            return history.filter(w => {
                const date = new Date(w.date);
                return date >= lastWeekStart && date < thisWeekStart;
            });
        }

        function countPRs(history) {
            const exerciseGroups = {};
            
            history.forEach(workout => {
                const key = `${workout.day}-${workout.exercise}`;
                if (!exerciseGroups[key]) {
                    exerciseGroups[key] = [];
                }
                const max1RM = Math.max(...workout.sets.map(s => calculate1RM(s.weight, s.reps)));
                exerciseGroups[key].push(max1RM);
            });
            
            let prCount = 0;
            Object.values(exerciseGroups).forEach(rms => {
                const max = Math.max(...rms);
                prCount += 1;
            });
            
            return prCount;
        }

        // ============================================
        // MODAL DISPLAY FUNCTIONS
        // ============================================
        function showWeeklyBreakdown() {
            const allHistory = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const thisWeek = getThisWeekWorkouts(allHistory);
            
            const sessions = {};
            thisWeek.forEach(workout => {
                const dateKey = new Date(workout.date).toDateString();
                const sessionKey = `${dateKey}-${workout.day}`;
                if (!sessions[sessionKey]) {
                    sessions[sessionKey] = { date: workout.date, day: workout.day, exercises: [] };
                }
                sessions[sessionKey].exercises.push(workout);
            });
            
            const sortedSessions = Object.values(sessions).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let content = `
                <div style="padding: 24px;">
                    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: var(--niue-blue); margin-bottom: 20px; letter-spacing: 1px;">This Week's Workouts</div>
            `;
            
            if (sortedSessions.length === 0) {
                content += '<div style="text-align: center; color: #999; padding: 40px 20px; font-style: italic;">No workouts this week yet. Time to get started!</div>';
            } else {
                sortedSessions.forEach((session, idx) => {
                    const date = new Date(session.date).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                    const totalVolume = session.exercises.reduce((sum, ex) => 
                        sum + ex.sets.reduce((s, set) => s + (set.weight * set.reps), 0), 0
                    );
                    content += `
                        <div onclick="openSessionFromWeekly(${idx})" style="background: var(--pale-yellow); padding: 16px; border-radius: 10px; margin-bottom: 12px; border-left: 4px solid var(--niue-yellow); cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-weight: 700; color: var(--niue-blue);">${date} - Day ${session.day}</div>
                                <div style="font-size: 20px;">‚Üí</div>
                            </div>
                            <div style="font-size: 14px; color: var(--light-blue);">${session.exercises.length} exercises ‚Ä¢ ${Math.round(totalVolume)}kg volume</div>
                        </div>
                    `;
                });
                
                window.tempWeeklySessions = sortedSessions;
            }
            
            content += '<button onclick="closeModal()" style="width: 100%; padding: 16px; background: var(--niue-blue); color: white; border: none; border-radius: 10px; font-family: \'Bebas Neue\', sans-serif; font-size: 18px; cursor: pointer; margin-top: 20px;">Close</button></div>';
            
            hideWorkoutElements();
            
            const historySection = document.querySelector('.history-section');
            historySection.insertAdjacentHTML('beforebegin', `<div id="sessionDetailContent">${content}</div>`);
            
            document.getElementById('exerciseModal').classList.add('active');
            
            history.pushState({ page: 'weekly-breakdown', timestamp: Date.now() }, '', '');
            historyStack.push('weekly-breakdown');
        }

        function openSessionFromWeekly(index) {
            const session = window.tempWeeklySessions[index];
            const allHistory = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            
            document.getElementById('sessionDetailContent').remove();
            
            openSessionDetail(session, allHistory);
        }

        function showPRList() {
            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            
            const exercisePRs = {};
            
            history.forEach(workout => {
                const key = workout.exercise;
                if (!exercisePRs[key]) {
                    exercisePRs[key] = {
                        exercise: workout.exercise,
                        heaviest: { weight: 0, reps: 0, date: null },
                        bestVolume: { weight: 0, reps: 0, volume: 0, date: null }
                    };
                }
                
                workout.sets.forEach(set => {
                    if (set.weight > exercisePRs[key].heaviest.weight) {
                        exercisePRs[key].heaviest = {
                            weight: set.weight,
                            reps: set.reps,
                            date: workout.date
                        };
                    }
                    
                    const volume = set.weight * set.reps;
                    if (volume > exercisePRs[key].bestVolume.volume) {
                        exercisePRs[key].bestVolume = {
                            weight: set.weight,
                            reps: set.reps,
                            volume: volume,
                            date: workout.date
                        };
                    }
                });
            });
            
            const prs = Object.values(exercisePRs).sort((a, b) => b.heaviest.weight - a.heaviest.weight);
            
            let content = `
                <div style="padding: 24px;">
                    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: var(--niue-blue); margin-bottom: 20px; letter-spacing: 1px;">Personal Records</div>
            `;
            
            if (prs.length === 0) {
                content += '<div style="text-align: center; color: #999; padding: 40px 20px; font-style: italic;">No PRs yet. Start logging workouts!</div>';
            } else {
                prs.forEach(pr => {
                    const heaviestDate = new Date(pr.heaviest.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const volumeDate = new Date(pr.bestVolume.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    
                    content += `
                        <div style="background: linear-gradient(135deg, #fff9e6 0%, #fffbf0 100%); padding: 16px; border-radius: 10px; margin-bottom: 16px; border-left: 4px solid #ffd700;">
                            <div style="font-weight: 700; color: var(--niue-blue); font-size: 18px; margin-bottom: 12px;">${pr.exercise}</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <div>
                                    <div style="font-size: 12px; color: #888; margin-bottom: 4px;">üèÜ HEAVIEST</div>
                                    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 24px; color: var(--niue-blue);">${pr.heaviest.weight}kg √ó ${pr.heaviest.reps}</div>
                                    <div style="font-size: 11px; color: #888;">${heaviestDate}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 12px; color: #888; margin-bottom: 4px;">üí™ BEST SET</div>
                                    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 24px; color: var(--niue-blue);">${pr.bestVolume.weight}kg √ó ${pr.bestVolume.reps}</div>
                                    <div style="font-size: 11px; color: #888;">${Math.round(pr.bestVolume.volume)}kg volume ‚Ä¢ ${volumeDate}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            content += '<button onclick="closeModal()" style="width: 100%; padding: 16px; background: var(--niue-blue); color: white; border: none; border-radius: 10px; font-family: \'Bebas Neue\', sans-serif; font-size: 18px; cursor: pointer; margin-top: 20px;">Close</button></div>';
            
            hideWorkoutElements();
            
            const historySection = document.querySelector('.history-section');
            historySection.insertAdjacentHTML('beforebegin', `<div id="sessionDetailContent">${content}</div>`);
            
            document.getElementById('exerciseModal').classList.add('active');
            
            history.pushState({ page: 'pr-list', timestamp: Date.now() }, '', '');
            historyStack.push('pr-list');
        }

        function showBestLifts() {
            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            
            const exerciseGroups = {};
            history.forEach(workout => {
                if (!exerciseGroups[workout.exercise]) {
                    exerciseGroups[workout.exercise] = [];
                }
                const max1RM = Math.max(...workout.sets.map(s => calculate1RM(s.weight, s.reps)));
                exerciseGroups[workout.exercise].push(max1RM);
            });
            
            const best1RMs = Object.entries(exerciseGroups).map(([exercise, rms]) => ({
                exercise,
                best1RM: Math.max(...rms)
            })).sort((a, b) => b.best1RM - a.best1RM);
            
            let content = `
                <div style="padding: 24px;">
                    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: var(--niue-blue); margin-bottom: 12px; letter-spacing: 1px;">Best Lifts (Est. 1RM)</div>
                    <div style="background: var(--pale-yellow); padding: 16px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid var(--niue-yellow);">
                        <div style="font-size: 14px; color: var(--light-blue); line-height: 1.6;">
                            Your estimated one-rep max (1RM) for each exercise, calculated from your logged sets using the Brzycki formula.
                        </div>
                    </div>
            `;
            
            if (best1RMs.length === 0) {
                content += '<div style="text-align: center; color: #999; padding: 40px 20px; font-style: italic;">No data yet. Start logging!</div>';
            } else {
                best1RMs.forEach(item => {
                    content += `
                        <div style="background: white; padding: 16px; border-radius: 10px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--niue-blue); box-shadow: 0 2px 8px var(--shadow);">
                            <div style="font-weight: 600; color: var(--niue-blue); font-size: 16px;">${item.exercise}</div>
                            <div style="font-family: 'Bebas Neue', sans-serif; font-size: 32px; color: var(--niue-blue);">${item.best1RM}<span style="font-size: 16px; color: var(--light-blue);">kg</span></div>
                        </div>
                    `;
                });
            }
            
            content += '<button onclick="closeModal()" style="width: 100%; padding: 16px; background: var(--niue-blue); color: white; border: none; border-radius: 10px; font-family: \'Bebas Neue\', sans-serif; font-size: 18px; cursor: pointer; margin-top: 20px;">Close</button></div>';
            
            hideWorkoutElements();
            
            const historySection = document.querySelector('.history-section');
            historySection.insertAdjacentHTML('beforebegin', `<div id="sessionDetailContent">${content}</div>`);
            
            document.getElementById('exerciseModal').classList.add('active');
            
            history.pushState({ page: 'best-lifts', timestamp: Date.now() }, '', '');
            historyStack.push('best-lifts');
        }

        function showAccessoryBreakdown() {
            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const accessoryData = calculateAccessoryScore(history);
            
            let content = `
                <div style="padding: 24px;">
                    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: var(--niue-blue); margin-bottom: 12px; letter-spacing: 1px;">Accessory Lifts</div>
                    <div style="background: var(--pale-yellow); padding: 16px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid var(--niue-yellow);">
                        <div style="font-size: 14px; color: var(--light-blue); line-height: 1.6;">
                            Total accessory strength: <strong>${accessoryData.total}kg</strong> across ${accessoryData.count} lifts
                        </div>
                    </div>
            `;
            
            if (accessoryData.count === 0) {
                content += '<div style="text-align: center; color: #999; padding: 40px 20px; font-style: italic;">No accessory lifts logged yet.</div>';
            } else {
                Object.entries(accessoryData.details)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([name, weight]) => {
                        content += `
                            <div style="background: white; padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid var(--niue-yellow);">
                                <span style="font-weight: 500; color: var(--niue-blue);">${name}</span>
                                <span style="font-family: 'Bebas Neue', sans-serif; font-size: 20px; color: var(--niue-blue);">${weight}kg</span>
                            </div>
                        `;
                    });
            }
            
            content += '<button onclick="closeModal()" style="width: 100%; padding: 16px; background: var(--niue-blue); color: white; border: none; border-radius: 10px; font-family: \'Bebas Neue\', sans-serif; font-size: 18px; cursor: pointer; margin-top: 20px;">Close</button></div>';
            
            hideWorkoutElements();
            
            const historySection = document.querySelector('.history-section');
            historySection.insertAdjacentHTML('beforebegin', `<div id="sessionDetailContent">${content}</div>`);
            
            document.getElementById('exerciseModal').classList.add('active');
            
            history.pushState({ page: 'accessory-breakdown', timestamp: Date.now() }, '', '');
            historyStack.push('accessory-breakdown');
        }

        function hideWorkoutElements() {
            document.getElementById('modalExerciseName').textContent = '';
            document.getElementById('modalExerciseTarget').textContent = '';
            
            document.getElementById('viewOnlyNotice').style.display = 'none';
            document.getElementById('restTimer').style.display = 'none';
            document.getElementById('prefillSection').style.display = 'none';
            
            const sectionTitles = document.querySelectorAll('.section-title');
            sectionTitles.forEach(title => title.style.display = 'none');
            
            document.getElementById('setsContainer').style.display = 'none';
            document.getElementById('addSetBtn').style.display = 'none';
            document.querySelector('.stats-grid').style.display = 'none';
            document.querySelector('.notes-section').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'none';
            document.querySelector('.history-section').style.display = 'none';
        }

        // ============================================
        // EXPORT/IMPORT
        // ============================================
        function exportData() {
            const history = localStorage.getItem('workoutHistory') || '[]';
            const weightHistory = localStorage.getItem('weightHistory') || '[]';
            const data = {
                version: '5.1',
                exportDate: new Date().toISOString(),
                workouts: JSON.parse(history),
                weightHistory: JSON.parse(weightHistory)
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rugby-strength-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast(`‚úÖ Exported ${data.workouts.length} workouts!`, 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (!data.workouts || !Array.isArray(data.workouts)) {
                            showToast('‚ùå Invalid backup file format', 'error');
                            return;
                        }
                        
                        const existingHistory = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
                        let action = 'replace';
                        
                        if (existingHistory.length > 0) {
                            action = confirm(
                                `You have ${existingHistory.length} existing workouts.\n\n` +
                                `OK = MERGE (keep existing + add imported)\n` +
                                `Cancel = REPLACE (delete existing, use only imported)`
                            ) ? 'merge' : 'replace';
                        }
                        
                        let finalHistory;
                        if (action === 'merge') {
                            const combined = [...existingHistory, ...data.workouts];
                            const uniqueIds = new Set();
                            finalHistory = combined.filter(w => {
                                if (uniqueIds.has(w.id)) return false;
                                uniqueIds.add(w.id);
                                return true;
                            });
                            
                            const combinedWeights = [
                                ...JSON.parse(localStorage.getItem('weightHistory') || '[]'),
                                ...(data.weightHistory || [])
                            ];
                            const uniqueWeightIds = new Set();
                            const finalWeights = combinedWeights.filter(w => {
                                if (uniqueWeightIds.has(w.id)) return false;
                                uniqueWeightIds.add(w.id);
                                return true;
                            });
                            
                            localStorage.setItem('weightHistory', JSON.stringify(finalWeights));
                        } else {
                            finalHistory = data.workouts;
                            localStorage.setItem('weightHistory', JSON.stringify(data.weightHistory || []));
                        }
                        
                        localStorage.setItem('workoutHistory', JSON.stringify(finalHistory));
                        
                        showToast(`‚úÖ Successfully imported ${data.workouts.length} workouts!\nTotal workouts: ${finalHistory.length}`, 'success');
                        
                        renderHistory();
                        renderDay();
                        if (document.getElementById('statsTab').style.display !== 'none') {
                            renderStats();
                        }
                        
                    } catch (err) {
                        showToast('‚ùå Error reading backup file: ' + err.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function migrateOldData() {
            let history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            let migrated = 0;
            
            history = history.map(workout => {
                if (!workout.id) {
                    migrated++;
                    return {
                        ...workout,
                        id: Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9)
                    };
                }
                return workout;
            });
            
            if (migrated > 0) {
                localStorage.setItem('workoutHistory', JSON.stringify(history));
                console.log(`Migrated ${migrated} workouts to include IDs`);
            }
            
            let weightHistory = JSON.parse(localStorage.getItem('weightHistory') || '[]');
            let weightMigrated = 0;
            
            weightHistory = weightHistory.map(entry => {
                if (!entry.id) {
                    weightMigrated++;
                    return {
                        ...entry,
                        id: Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9)
                    };
                }
                return entry;
            });
            
            if (weightMigrated > 0) {
                localStorage.setItem('weightHistory', JSON.stringify(weightHistory));
                console.log(`Migrated ${weightMigrated} weight entries to include IDs`);
            }
        }

        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let currentDay = 'A';
        let currentExercise = null;
        let currentExerciseIndex = 0;
        let currentSetCount = 0;
        let workoutActive = false;
        let sessionStartTime = null;
        let sessionInterval = null;
        let restTimerInterval = null;
        let restTimerSeconds = 90;
        let restTimerActive = false;
        let mobilityTimerInterval = null;
        let mobilityTimerSeconds = 45;
        let mobilityTimerActive = false;
        let currentLogFilter = 'all';
        let currentEditWorkoutId = null;
        let lastDeletedWorkout = null;
        let undoTimeout = null;
        let autoSaveInterval = null;

        // Session persistence constants
        const SESSION_STORAGE_KEY = 'activeWorkoutSession';
        const SESSION_TIMEOUT = 4 * 60 * 60 * 1000;

        // ============================================
        // INITIALIZE
        // ============================================
        document.getElementById('exerciseModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.getElementById('summaryModal').addEventListener('click', function(e) {
            if (e.target === this) closeSummary();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const exerciseModal = document.getElementById('exerciseModal');
                const summaryModal = document.getElementById('summaryModal');
                
                if (exerciseModal.classList.contains('active')) {
                    closeModal();
                } else if (summaryModal.classList.contains('active')) {
                    closeSummary();
                }
            }
        });

        // Initialize
        migrateOldData();
        
        history.replaceState({ page: 'home', timestamp: Date.now() }, '', '');
        historyStack.replace('home');
        
        if (!restoreSessionState()) {
            renderHome();
            renderDay();
        }
    </script>
</body>
</html>
